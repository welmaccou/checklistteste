<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Checklist - Matr√≠cula SISU UFG</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* --- Estilos Visuais --- */
    :root { --primary: #0056b3; --primary-light: #007BFF; --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); --surface: #ffffff; --text: #333333; --border: #e0e0e0; --shadow: 0 10px 30px rgba(0,0,0,0.1); --success: #28a745; --warning: #ffc107; --whatsapp: #25D366; --pdf-color: #b30b00; }
    body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-image: var(--bg-gradient); margin: 0; padding: 20px; min-height: 100vh; color: var(--text); display: flex; flex-direction: column; align-items: center; }
    
    .container { background: var(--surface); width: 100%; max-width: 850px; padding: 40px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 40px; position: relative; }
    
    /* Cabe√ßalhos e T√≠tulos */
    h1 { color: var(--primary); text-align: center; margin-bottom: 10px; font-weight: 700; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.95rem; }
    .checklist-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    .checklist-header h1 { margin: 0; font-size: 1.8rem; color: var(--primary); }
    .checklist-header p { margin: 5px 0 0; color: #666; font-style: italic; }

    .alert { background: #e7f1ff; border-left: 5px solid var(--primary-light); padding: 15px; border-radius: 4px; font-size: 0.9rem; margin-bottom: 30px; }
    .section-header { border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin: 30px 0 20px 0; color: var(--primary); font-size: 1.2rem; font-weight: 600; }
    
    /* Formul√°rios */
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; font-size: 0.9rem; }
    input[type="text"], input[type="number"], input[type="password"], select { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; box-sizing: border-box; background: #fcfcfc; }
    input:focus, select:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); }
    
    /* Bot√µes e Toolbar */
    .btn-primary { background: var(--primary-light); color: white; border: none; padding: 14px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px; transition: background 0.3s, transform 0.2s; }
    .btn-primary:hover { background: var(--primary); transform: translateY(-2px); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    
    .toolbar { display: flex; gap: 8px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
    .btn-tool { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: opacity 0.2s; }
    .btn-tool:hover { opacity: 0.9; }
    .btn-print { background: #6c757d; }
    .btn-save { background: var(--success); }
    .btn-link { background: var(--warning); color: #333; }
    .btn-back { background: var(--primary); }
    .btn-whatsapp { background: var(--whatsapp); }
    .btn-pdf { background: var(--pdf-color); }
    
    /* Checklist - Blocos */
    #checklist-screen { display: none; }
    .person-block { margin-bottom: 25px; padding: 15px; border-left: 5px solid #0056b3; background-color: #fcfcfc; page-break-inside: avoid; }
    .checklist-content h3 { margin-top: 0; margin-bottom: 10px; color: #333; font-size: 1.2rem; text-transform: uppercase; }
    .checklist-content ul { list-style: none; padding-left: 0; margin-top: 5px; }
    
    /* Checklist - Itens */
    li.doc-item { position: relative; margin-bottom: 4px; padding: 4px; border-radius: 4px; transition: background-color 0.2s; }
    li.doc-item:hover { background-color: #f0f0f0; }
    .doc-label { display: flex; align-items: flex-start; cursor: pointer; width: 100%; }
    .doc-checkbox { appearance: none; -webkit-appearance: none; min-width: 20px; width: 20px; height: 20px; border: 2px solid #000; margin-right: 12px; position: relative; display: flex; align-items: center; justify-content: center; margin-top: 2px; background: #fff; cursor: pointer; flex-shrink: 0; }
    .doc-checkbox:checked::after { content: 'X'; font-weight: 900; color: #000; font-size: 16px; line-height: 1; font-family: Arial, sans-serif; }
    .doc-text { flex: 1; line-height: 1.4; word-break: break-word; }
    .doc-text a { color: #0056b3; font-weight: bold; text-decoration: underline; }
    
    .btn-remove { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; display: none; z-index: 10; }
    li.doc-item:hover .btn-remove { display: block; }
    .extra-docs { background: #fffbe6; padding: 15px; border: 1px solid #ffe58f; border-radius: 4px; margin-top: 20px; }
    
    /* Adicionar Documento */
    .add-doc-row { display: flex; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }
    .add-doc-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
    .btn-add-item { background: #28a745; color: white; border: none; border-radius: 4px; padding: 0 15px; cursor: pointer; font-weight: bold; }
    
    /* Admin e Modal */
    footer { text-align: center; margin-top: auto; padding: 20px; font-size: 0.8rem; }
    .admin-link { color: #aaa; text-decoration: none; }
    #admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto; }
    .admin-content { background: white; margin: 30px auto; padding: 30px; width: 90%; max-width: 900px; border-radius: 12px; position: relative; }
    .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; overflow-x: auto; }
    .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; white-space: nowrap; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .item-list { border: 1px solid #eee; border-radius: 8px; max-height: 400px; overflow-y: auto; }
    .list-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: #fff; }
    .btn-sm { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 5px; }
    .btn-edit { background: #ffc107; color: #333; }
    .btn-del { background: #dc3545; color: white; }
    .btn-add { background: #28a745; color: white; }
    
    /* Dropdown Custom */
    .dropdown-container { position: relative; user-select: none; }
    .dropdown-trigger { background: #fff; border: 1px solid var(--border); padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; min-height: 48px; }
    .dropdown-trigger::after { content: ''; border: 5px solid transparent; border-top-color: #666; margin-left: 10px; }
    .dropdown-menu { position: absolute; top: 105%; left: 0; width: 100%; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); z-index: 100; max-height: 300px; overflow-y: auto; display: none; padding-top: 5px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; transition: background 0.2s; }
    .dropdown-item:hover { background-color: #f0f7ff; }
    .dropdown-item input[type="checkbox"] { margin-right: 12px; transform: scale(1.2); cursor: pointer; }
    .dropdown-ok { padding: 8px; border-top: 1px solid #eee; position: sticky; bottom: 0; background: white; text-align: center; }
    .dropdown-ok button { background: var(--success); color: white; border: none; padding: 6px 0; width: 90%; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
    .dropdown-ok button:hover { background: #218838; }

    /* Loading Overlay */
    #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0056b3; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- REGRAS PARA IMPRESS√ÉO E PDF --- */
    /* A classe .pdf-mode √© adicionada dinamicamente durante a gera√ß√£o do PDF via JS.
       O @media print √© para quando o usu√°rio usa o Ctrl+P do navegador.
    */
    @media print {
      body { padding: 0; font-size: 12pt; background: white; }
      .container { box-shadow: none; padding: 0; max-width: 100%; }
      .toolbar, footer, #creation-screen, #loading-overlay, .add-doc-row, .btn-remove { display: none !important; }
      #checklist-screen { display: block !important; }
      li.doc-item:hover { background-color: transparent; }
      .person-block { border-left-width: 2px; }
      .doc-checkbox { -webkit-print-color-adjust: exact; print-color-adjust: exact; border-color: #000 !important; }
      .doc-checkbox:checked::after { color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    /* Regras espec√≠ficas para o gerador de PDF (html2canvas) */
    .pdf-mode .toolbar,
    .pdf-mode .add-doc-row,
    .pdf-mode .btn-remove {
      display: none !important;
    }
    .pdf-mode .container {
      box-shadow: none;
      padding: 20px; /* Reduz padding para caber melhor */
    }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-text" style="margin-top:15px; font-weight:bold; color:#0056b3;">Carregando dados...</p>
  </div>

  <div class="container" id="main-container">
    
    <div id="creation-screen">
      <h1>Gerador de Checklist</h1>
      <div class="subtitle">Matr√≠cula SISU UFG - An√°lise Socioecon√¥mica</div>
      <div id="step-1">
        <label for="family-size">Quantidade de pessoas no grupo familiar (al√©m do candidato):</label>
        <div style="display: flex; gap: 10px;">
          <input type="number" id="family-size" min="0" value="0">
          <button class="btn-primary" style="width: auto; margin-top:0;" onclick="renderForm()">Iniciar</button>
        </div>
      </div>
      <div id="form-container"></div>
    </div>

    <div id="checklist-screen">
      <div class="toolbar">
        <button class="btn-tool btn-back" onclick="closeChecklist()">‚¨Ö Voltar</button>
        <button class="btn-tool btn-save" onclick="manualSave()">üíæ Salvar</button>
        <button class="btn-tool btn-link" onclick="copyLink()">üîó Link</button>
        <button class="btn-tool btn-whatsapp" onclick="sendWhatsApp()">üì± WhatsApp</button>
        <button class="btn-tool btn-print" onclick="printAndSaveToCloud()">üñ®Ô∏è Imprimir</button>
        <button class="btn-tool btn-pdf" onclick="generatePDF()">üìÑ Baixar PDF</button>
      </div>
      
      <div id="printable-area">
        <div class="checklist-header">
          <h1>Checklist de Documentos - SISU</h1>
          <p>Este documento √© um guia auxiliar. N√£o substitui o edital oficial.</p>
        </div>
        <div id="checklist-content" class="checklist-content"></div>
      </div>
    </div>

  </div>

  <footer>
    <div id="status-bar" style="margin-bottom:10px; font-size:0.8rem; color:#666;"></div>
    <a href="#" class="admin-link" onclick="openAdmin()">√Årea Administrativa</a>
  </footer>

  <div id="admin-modal">
    <div class="admin-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; color:var(--primary);">Painel Administrativo</h2>
        <button class="btn-sm" onclick="closeAdmin()" style="background:#666; color:white;">Fechar</button>
      </div>

      <div id="login-screen">
        <label>Senha de Acesso (Cofre):</label>
        <div style="display:flex; gap:10px;">
          <input type="password" id="admin-pass" placeholder="Sua senha de admin">
          <button class="btn-sm btn-primary" style="margin:0; width:auto;" onclick="checkLogin()">Entrar</button>
        </div>
      </div>

      <div id="admin-panel" style="display:none;">
        <div class="admin-tabs">
          <button class="tab-btn active" onclick="switchTab('saved')">Candidatos</button>
          <button class="tab-btn" onclick="switchTab('situations')">Situa√ß√µes</button>
          <button class="tab-btn" onclick="switchTab('questions')">Perguntas</button>
          <button class="tab-btn" onclick="openGithubConfig()" style="color:#24292e;">üîê Cofre GitHub</button>
        </div>

        <div id="tab-saved">
          <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <input type="text" id="search-candidate" placeholder="üîç Buscar candidato por nome..." onkeyup="filterCandidates()" style="padding: 10px;">
          </div>
          <div class="item-list" id="saved-list"></div>
        </div>

        <div id="tab-situations" style="display:none;">
          <button class="btn-sm btn-add" onclick="editSituation(-1)">+ Nova Situa√ß√£o</button>
          <div class="item-list" id="situations-list" style="margin-top:10px;"></div>
        </div>

        <div id="tab-questions" style="display:none;">
          <button class="btn-sm btn-add" onclick="editQuestion(-1)">+ Nova Pergunta</button>
          <div class="item-list" id="questions-list" style="margin-top:10px;"></div>
        </div>

        <div id="github-config" style="display:none; margin-top:20px; padding:20px; border:1px solid #ccc; background:#f9f9f9; border-radius:8px;">
          <h3>Configura√ß√£o de Nuvem (Criptografia Forte)</h3>
          <label>Senha de Admin (Definir nova):</label><input type="text" id="new-admin-pass">
          <label>Usu√°rio GitHub:</label><input type="text" id="gh-user">
          <label>Nome do Reposit√≥rio:</label><input type="text" id="gh-repo">
          <label>Token (PAT):</label><input type="password" id="gh-token">
          <div style="margin-top:10px; display:flex; gap:10px;">
             <button class="btn-primary" style="margin:0; background:#24292e;" onclick="generateSecureConfig()">Gerar C√≥digo Seguro</button>
             <button class="btn-sm" onclick="document.getElementById('github-config').style.display='none'">Cancelar</button>
          </div>
          <div id="obfuscated-output" style="display:none; margin-top:15px;">
            <label>Substitua a vari√°vel SECURE_DATA no c√≥digo:</label>
            <textarea id="output-code" style="width:100%; height:80px; font-family:monospace; font-size:0.8rem;"></textarea>
          </div>
        </div>

        <div id="edit-overlay" style="display:none; margin-top:20px; padding-top:20px; border-top:2px dashed #ccc;">
          <h3 id="edit-title">Editar</h3>
          <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
          <label>T√≠tulo:</label><input type="text" id="edit-label">
          <div id="situation-fields" style="display:none;">
            <label>Documentos:</label>
            <p style="font-size:0.8em; color:#666; margin:0 0 5px 0;">Use: <b>[Texto do Link](http://site.com)</b></p>
            <textarea id="sit-docs" style="width:100%; min-height:150px;"></textarea>
          </div>
          <div id="question-fields" style="display:none;"><label>Op√ß√µes:</label><div id="options-container"></div><button class="btn-sm btn-add" onclick="addOptionRow()">+ Op√ß√£o</button></div>
          <div style="margin-top:15px; display:flex; gap:10px;"><button class="btn-primary" onclick="saveEdit()">Salvar na Nuvem</button><button class="btn-sm" style="background:#999; color:white;" onclick="cancelEdit()">Cancelar</button></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==========================================================================
   DADOS SEGUROS (Cole o bloco gerado aqui)
   ========================================================================== */
const GLOBAL_CONFIG = {
  "u": "JCw/OD4zNi0q",
  "r": "MCE2NjQ8PDErPyAqKzM=",
  "t": "NCAnPSoyCjI+PxpobhcEAH4LYQ5gHxEeDw8Waz8LPgEwChIIHQU+GSsvNgVwPR0pDDUhYwAVDw0LPg5fBjweGG4SGSE0fAsPGQVGOBsFHh1mFwYcBHBhKx98ITEx",
  "h": "d5a7d040e8c9a049f1b2ebdaa96fb34ea6f9a67197a7b27c0fe387db70e55bef"
};

/* ==========================================================================
   CRIPTOGRAFIA (AES-GCM) & OFUSCA√á√ÉO
   ========================================================================== */
async function getKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
  return window.crypto.subtle.deriveKey(
    { name: "PBKDF2", salt: Uint8Array.from(atob(salt), c => c.charCodeAt(0)), iterations: 100000, hash: "SHA-256" },
    keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
  );
}
async function encryptToken(token, password) {
  const salt = window.crypto.getRandomValues(new Uint8Array(16));
  const iv = window.crypto.getRandomValues(new Uint8Array(12));
  const key = await getKey(password, btoa(String.fromCharCode(...salt)));
  const encoded = new TextEncoder().encode(token);
  const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, encoded);
  return { salt: btoa(String.fromCharCode(...salt)), iv: btoa(String.fromCharCode(...iv)), data: btoa(String.fromCharCode(...new Uint8Array(encrypted))) };
}
async function decryptToken(encryptedObj, password) {
  try {
    const key = await getKey(password, encryptedObj.salt);
    const iv = Uint8Array.from(atob(encryptedObj.iv), c => c.charCodeAt(0));
    const data = Uint8Array.from(atob(encryptedObj.data), c => c.charCodeAt(0));
    const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
    return new TextDecoder().decode(decrypted);
  } catch (e) { return null; }
}
const _k = "SISU_PUB";
function _obf(s){if(!s)return "";let r="";for(let i=0;i<s.length;i++)r+=String.fromCharCode(s.charCodeAt(i)^_k.charCodeAt(i%_k.length));return btoa(r);}
function _deobf(s){if(!s)return "";try{let d=atob(s),r="";for(let i=0;i<d.length;i++)r+=String.fromCharCode(d.charCodeAt(i)^_k.charCodeAt(i%_k.length));return r;}catch(e){return "";}}

// Token descriptografado (apenas para Admin)
let DECRYPTED_TOKEN = null;

/* ==========================================================================
   DADOS PADR√ÉO
   ========================================================================== */
const defaultData = {
  situations: [
    { id: 'assalariado', label: 'Assalariado', docs: ['Contracheques (Out, Nov, Dez 2025)', 'CTPS completa', 'IRPF 2025 (se declarou)'] },
    { id: 'autonomo', label: 'Aut√¥nomo/Informal', docs: ['Declara√ß√£o de Aut√¥nomo', 'CTPS', 'Extratos banc√°rios'] },
    { id: 'aposentado', label: 'Aposentado/Pensionista', docs: ['Extrato do benef√≠cio', 'IRPF 2025'] },
    { id: 'mei', label: 'Microempreendedor (MEI)', docs: ['DASN Simei', 'Declara√ß√£o de MEI', 'Extratos'] },
    { id: 'desempregado', label: 'Desempregado', docs: ['CTPS (Baixa)', 'Declara√ß√£o de desemprego', 'Seguro-desemprego (se houver)'] },
    { id: 'nunca', label: 'Nunca Trabalhou', docs: ['CTPS (em branco)', 'CNIS (se maior de 18)'] }
  ],
  questions: [
    { id: 'moradia', text: 'Moradia', options: [ { label: 'Alugada', docs: ['Contrato de loca√ß√£o ou recibos.'] }, { label: 'Cedida', docs: ['Declara√ß√£o de im√≥vel cedido.'] }, { label: 'Financiada', docs: ['Comprovante da presta√ß√£o.'] }, { label: 'Pr√≥pria', docs: [] } ]},
    { id: 'orfao', text: '√â solteiro(a) com pais falecidos?', options: [ { label: 'Sim', docs: ['Certid√£o de √≥bito pai/m√£e.'] }, { label: 'N√£o', docs: [] } ]},
    { id: 'aluguel', text: 'Renda de aluguel?', options: [ { label: 'Sim', docs: ['Contratos e recibos de aluguel.'] }, { label: 'N√£o', docs: [] } ]},
    { id: 'rural', text: 'Propriet√°rio rural?', options: [ { label: 'Sim', docs: ['Escritura/INCRA', 'DITR 2025'] }, { label: 'N√£o', docs: [] } ]}
  ]
};

let appData = defaultData;
let savedLists = [];
let currentSHA = null;
let currentChecklistId = null; 
let isDirty = false; 

window.addEventListener('beforeunload', (e) => { if (isDirty) { e.preventDefault(); e.returnValue = 'Altera√ß√µes n√£o salvas.'; } });

/* ==========================================================================
   GITHUB API (H√≠brida: Leitura P√∫blica / Escrita Privada)
   ========================================================================== */
window.onload = async function() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');

  if(SECURE_DATA) {
    await fetchPublicData();
    if(id) loadChecklist(parseInt(id));
  } else {
    document.getElementById('status-bar').textContent = "‚ö†Ô∏è Sistema n√£o configurado. Acesse a √Årea Admin.";
  }
};

async function fetchPublicData() {
  showLoading('Carregando dados...');
  const user = _deobf(SECURE_DATA.u);
  const repo = _deobf(SECURE_DATA.r);
  const url = `https://raw.githubusercontent.com/${user}/${repo}/main/database.json`;

  try {
    // Adiciona timestamp para evitar cache do navegador
    const resp = await fetch(url + '?t=' + new Date().getTime()); 
    if(resp.ok) {
      const json = await resp.json();
      appData = json.appData || defaultData;
      savedLists = json.savedLists || [];
      document.getElementById('status-bar').textContent = "‚úÖ Dados carregados.";
    } else {
      document.getElementById('status-bar').textContent = "‚ÑπÔ∏è Reposit√≥rio n√£o encontrado ou privado.";
    }
  } catch(e) { console.error("Erro leitura p√∫blica:", e); } finally { hideLoading(); }
}

// Necess√°rio para obter o SHA antes de salvar (API)
async function fetchSHAOnly() {
  if(!DECRYPTED_TOKEN) return null;
  const user = _deobf(SECURE_DATA.u);
  const repo = _deobf(SECURE_DATA.r);
  const url = `https://api.github.com/repos/${user}/${repo}/contents/database.json`;
  try {
    const resp = await fetch(url, { headers: { 'Authorization': `token ${DECRYPTED_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' } });
    if(resp.ok) {
      const json = await resp.json();
      currentSHA = json.sha;
      // Atualiza dados tamb√©m para garantir que n√£o sobrescreva com dados velhos
      const content = JSON.parse(decodeURIComponent(escape(atob(json.content))));
      savedLists = content.savedLists || savedLists;
      appData = content.appData || appData;
      return true;
    }
  } catch(e) { console.error(e); }
  return false;
}

async function pushToGithub() {
  if(!DECRYPTED_TOKEN) { 
    alert("Sess√£o expirada. Entre na √Årea Admin para salvar na nuvem."); 
    openAdmin(); 
    return false; 
  }
  showLoading('Salvando na Nuvem...');
  
  // Atualiza SHA e dados antes de salvar
  await fetchSHAOnly();

  const user = _deobf(SECURE_DATA.u);
  const repo = _deobf(SECURE_DATA.r);
  const url = `https://api.github.com/repos/${user}/${repo}/contents/database.json`;
  
  const payload = { appData, savedLists };
  const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));
  
  const body = { message: "Update SISU Data " + new Date().toISOString(), content: contentBase64 };
  if(currentSHA) body.sha = currentSHA;

  try {
    const resp = await fetch(url, {
      method: 'PUT',
      headers: { 'Authorization': `token ${DECRYPTED_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    
    if(resp.ok) {
      const json = await resp.json();
      currentSHA = json.content.sha;
      document.getElementById('status-bar').textContent = "‚úÖ Salvo com sucesso √†s " + new Date().toLocaleTimeString();
      return true;
    } else { throw new Error('Erro GitHub: ' + resp.status); }
  } catch(e) {
    alert("Falha ao salvar: " + e.message); return false;
  } finally { hideLoading(); }
}

/* ==========================================================================
   L√ìGICA PRINCIPAL (PDF, WHATSAPP, ETC)
   ========================================================================== */
function showLoading(msg) { document.getElementById('loading-text').textContent=msg; document.getElementById('loading-overlay').style.display='flex'; }
function hideLoading() { document.getElementById('loading-overlay').style.display='none'; }

function createMultiSelect(id, items) {
  const c = document.createElement('div'); c.className = 'dropdown-container'; c.id = `container-${id}`;
  const t = document.createElement('div'); t.className = 'dropdown-trigger'; t.innerHTML = '<span class="trigger-text">Selecione...</span>';
  t.onclick = (e) => { e.stopPropagation(); toggleDropdown(id); };
  const m = document.createElement('div'); m.className = 'dropdown-menu'; m.id = `menu-${id}`;
  items.forEach(i => {
    const r = document.createElement('label'); r.className = 'dropdown-item';
    r.innerHTML = `<input type="checkbox" value="${i.id}" onchange="updateTrigger('${id}')">${i.label}`;
    r.onclick = (e) => e.stopPropagation(); m.appendChild(r);
  });
  const okDiv = document.createElement('div'); okDiv.className = 'dropdown-ok';
  okDiv.innerHTML = '<button type="button">OK - Concluir</button>';
  okDiv.onclick = (e) => { e.stopPropagation(); toggleDropdown(id); };
  m.appendChild(okDiv);
  c.appendChild(t); c.appendChild(m); return c;
}
function toggleDropdown(id) { document.querySelectorAll('.dropdown-menu').forEach(m => { if(m.id !== `menu-${id}`) m.classList.remove('show'); }); document.getElementById(`menu-${id}`).classList.toggle('show'); }
function updateTrigger(id) {
  const c = document.getElementById(`container-${id}`); const ch = c.querySelectorAll('input:checked'); const s = c.querySelector('.trigger-text');
  s.textContent = !ch.length ? 'Selecione...' : Array.from(ch).map(x=>x.parentNode.textContent.trim()).join(', ');
  s.style.color = !ch.length ? '#666' : '#000';
}
document.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show')));

function renderForm() {
  const c = document.getElementById('form-container'); const s = parseInt(document.getElementById('family-size').value);
  if(isNaN(s)||s<0) return alert('Inv√°lido');
  c.innerHTML = ''; c.appendChild(createMemberCard('Candidato',0,true));
  for(let i=1; i<=s; i++) c.appendChild(createMemberCard(`Membro ${i}`,i,false));
  const b = document.createElement('button'); b.className = 'btn-primary'; b.textContent = 'Gerar Checklist'; b.onclick = generateChecklist; c.appendChild(b);
}
function createMemberCard(title, i, isCand) {
  const card = document.createElement('div'); card.style.cssText = 'background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:20px; margin-top:20px;';
  let h = `<div class="section-header" style="margin-top:0;">${title}</div><div style="margin-bottom:15px;"><label>Nome:</label><input type="text" id="name-${i}"></div><div style="margin-bottom:15px;"><label>Situa√ß√£o:</label><div id="sit-wrapper-${i}"></div></div>`;
  if(isCand) {
    h+=`<div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;"><h4 style="color:#666;">Complementar</h4>`;
    appData.questions.forEach((q,qi) => {
      let o = `<option value="">-- Escolha --</option>`; q.options.forEach((opt,oi)=> o+=`<option value="${qi}-${oi}">${opt.label}</option>`);
      h+=`<div style="margin-bottom:15px;"><label>${q.text}</label><select id="extra-${qi}">${o}</select></div>`;
    }); h+='</div>';
  }
  card.innerHTML = h; card.querySelector(`#sit-wrapper-${i}`).appendChild(createMultiSelect(`multi-${i}`, appData.situations)); return card;
}

function markDirty() { isDirty = true; }
function removeDoc(btn) { btn.parentElement.remove(); markDirty(); }
function addNewDoc(btn) {
  const input = btn.previousElementSibling; const text = input.value.trim(); if(!text) return;
  const ul = btn.closest('div').previousElementSibling; 
  const li = document.createElement('li'); li.className = 'doc-item';
  li.innerHTML = `<label class="doc-label"><input type="checkbox" class="doc-checkbox" onchange="markDirty()"><span class="doc-text">${formatDocText(text)}</span></label><button class="btn-remove" onclick="removeDoc(this)">Excluir</button>`;
  ul.appendChild(li); input.value = ''; markDirty();
}
function formatDocText(text) {
  let clean = text.replace(/^[\(\s\)]+/, '').trim();
  return clean.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">$1</a>');
}

function generateChecklist() {
  const size = parseInt(document.getElementById('family-size').value);
  const item = t => `<li class="doc-item"><label class="doc-label"><input type="checkbox" class="doc-checkbox" onchange="markDirty()"><span class="doc-text">${formatDocText(t)}</span></label><button class="btn-remove" onclick="removeDoc(this)">Excluir</button></li>`;
  const addBox = `<div class="add-doc-row"><input type="text" class="add-doc-input" placeholder="Adicionar documento..."><button class="btn-add-item" onclick="addNewDoc(this)">+</button></div>`;

  let html = '', cName = '';
  for(let i=0; i<=size; i++) {
    const n = document.getElementById(`name-${i}`).value.trim();
    if(!n && i===0) return alert('Nome do candidato √© obrigat√≥rio'); if(!n) continue; if(i===0) cName = n;
    const ch = document.querySelectorAll(`#container-multi-${i} input:checked`);
    
    html += `<div class="person-block"><h3>${i===0?'Candidato(a)':'Familiar'}: ${n}</h3><strong>B√°sicos:</strong><ul>${item('RG e CPF')}${i===0?item('Declara√ß√£o Composi√ß√£o Familiar'):''}${item('Extratos Banc√°rios')}${item('Registrato (BACEN)')}</ul>`;
    
    if(ch.length) { html+='<strong>Espec√≠ficos:</strong><ul>'; let d=[]; ch.forEach(c=>{ const s=appData.situations.find(x=>x.id===c.value); if(s) d.push(...s.docs); }); [...new Set(d)].forEach(x=>html+=item(x)); html+='</ul>'; }
    else html+='<p style="font-style:italic;color:#666">Nenhuma situa√ß√£o.</p>';
    html += addBox + '</div>';
  }
  let extra=''; appData.questions.forEach((q,qi)=>{ const v=document.getElementById(`extra-${qi}`).value; if(v){ const[x,y]=v.split('-'); const op=appData.questions[x].options[y]; if(op.docs.length) extra+=op.docs.map(d=>item(d)).join(''); }});
  html+=`<div class="extra-docs"><h3>Complementar</h3><ul>${extra}</ul>${addBox}</div>`;
  
  const content = document.getElementById('checklist-content'); content.innerHTML = html; content.dataset.candidate = cName;
  currentChecklistId = null; updateUrl(null); isDirty = true; 
  document.getElementById('creation-screen').style.display='none'; document.getElementById('checklist-screen').style.display='block'; window.scrollTo(0,0);
}

function closeChecklist() { 
  if(isDirty && !confirm("Existem altera√ß√µes n√£o salvas. Deseja realmente voltar?")) return;
  document.getElementById('checklist-screen').style.display='none'; document.getElementById('creation-screen').style.display='block'; 
  currentChecklistId=null; isDirty = false; updateUrl(null);
}
function updateUrl(id) { const url = new URL(window.location); if(id) url.searchParams.set('id', id); else url.searchParams.delete('id'); window.history.pushState({}, '', url); }

/* === GERAR PDF (NATIVO / JS PDF) === */
async function generatePDF() {
  const content = document.getElementById('printable-area');
  const container = document.getElementById('main-container');
  
  // Adiciona modo PDF para esconder bot√µes e inputs
  container.classList.add('pdf-mode');
  
  try {
    showLoading('Gerando PDF...');
    
    // Captura o checklist completo
    // Usar window.devicePixelRatio para melhor qualidade
    const canvas = await html2canvas(content, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    
    // Dimens√µes A4 em mm
    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
    const pageHeight = 297; 
    const pageWidth = 210;
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);
    
    // Dimens√µes da imagem no PDF
    const imgHeight = (canvas.height * contentWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    // Adiciona primeira p√°gina
    pdf.addImage(imgData, 'JPEG', margin, margin, contentWidth, imgHeight);
    heightLeft -= (pageHeight - (margin * 2));

    // Adiciona p√°ginas extras se necess√°rio
    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      // Ajusta posi√ß√£o para mostrar a continua√ß√£o
      pdf.addImage(imgData, 'JPEG', margin, margin - (imgHeight - heightLeft), contentWidth, imgHeight);
      heightLeft -= (pageHeight - (margin * 2));
    }

    const name = document.getElementById('checklist-content').dataset.candidate || 'checklist';
    pdf.save(`${name}.pdf`);
    
  } catch(e) {
    alert("Erro ao gerar PDF: " + e.message);
  } finally {
    container.classList.remove('pdf-mode');
    hideLoading();
  }
}

/* === WHATSAPP === */
async function sendWhatsApp() {
  if(isDirty || !currentChecklistId) {
    if(!confirm("√â necess√°rio salvar o checklist para gerar o link. Salvar agora?")) return;
    const ok = await saveLogic(true);
    if(!ok) return;
  }
  const url = window.location.href;
  const msg = encodeURIComponent(`Ol√°! Aqui est√° o link do seu checklist de documentos para o SISU UFG:\n\n${url}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/* === SALVAR / CARREGAR === */
async function saveLogic(silent = false) {
  // ATEN√á√ÉO: Verifica se tem Token. Se n√£o tiver, precisa logar no admin.
  if(!DECRYPTED_TOKEN) {
    alert("Para salvar, voc√™ precisa estar logado na √Årea Administrativa (Seguran√ßa).");
    openAdmin();
    return false;
  }

  const div = document.getElementById('checklist-content');
  const name = div.dataset.candidate || 'Sem Nome';
  // Atualiza HTML com checkboxes marcados
  div.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked ? c.setAttribute('checked','checked') : c.removeAttribute('checked'));
  const html = div.innerHTML;

  if(currentChecklistId) {
    const idx = savedLists.findIndex(l=>l.id===currentChecklistId);
    if(idx!==-1) { savedLists[idx].html=html; savedLists[idx].updated=new Date().toLocaleString(); }
  } else {
    const newId = Date.now();
    savedLists.push({ id:newId, name, html, created:new Date().toLocaleString(), updated:new Date().toLocaleString() });
    currentChecklistId = newId; updateUrl(newId);
  }
  const success = await pushToGithub();
  if(success) { isDirty = false; if(!silent) alert("Salvo com sucesso!"); }
  return success;
}
async function manualSave() { await saveLogic(false); }
async function printAndSaveToCloud() { 
  // Tenta salvar, se falhar (sem token), imprime igual
  if(DECRYPTED_TOKEN) await saveLogic(true); 
  else if(confirm("Aten√ß√£o: Voc√™ n√£o est√° logado como Admin, ent√£o o checklist N√ÉO ser√° salvo na nuvem. Deseja imprimir mesmo assim?")) { }
  else return;
  
  setTimeout(() => window.print(), 200); 
}

async function loadChecklist(id) {
  if(isDirty && !confirm("Altera√ß√µes n√£o salvas ser√£o perdidas. Continuar?")) return;
  // Recarrega do Cloud (P√∫blico) para garantir
  await fetchPublicData();
  const l = savedLists.find(x=>x.id===id); 
  if(!l) { alert('Checklist n√£o encontrado.'); updateUrl(null); return; }
  const c = document.getElementById('checklist-content'); c.innerHTML=l.html; c.dataset.candidate=l.name;
  currentChecklistId=l.id; isDirty = false; updateUrl(l.id); 
  closeAdmin(); document.getElementById('creation-screen').style.display='none'; document.getElementById('checklist-screen').style.display='block';
}
function copyLink() { if(!currentChecklistId || isDirty) return alert("Salve primeiro."); navigator.clipboard.writeText(window.location.href).then(()=>alert("Link copiado!")); }
async function deleteSavedList(id) { if(!confirm('Excluir?')) return; savedLists = savedLists.filter(x=>x.id!==id); const ok = await pushToGithub(); if(ok) renderSavedList(); }

/* === FILTRO DE BUSCA === */
function filterCandidates() {
  const term = document.getElementById('search-candidate').value.toLowerCase();
  const items = document.getElementById('saved-list').getElementsByClassName('list-row');
  Array.from(items).forEach(item => {
    const text = item.innerText.toLowerCase();
    item.style.display = text.includes(term) ? 'flex' : 'none';
  });
}

/* === ADMIN & CRIPTOGRAFIA === */
function openAdmin() { document.getElementById('admin-modal').style.display='block'; if(!SECURE_DATA) openGithubConfig(); }
function closeAdmin() { document.getElementById('admin-modal').style.display='none'; document.getElementById('login-screen').style.display='block'; document.getElementById('admin-panel').style.display='none'; document.getElementById('admin-pass').value=''; }

async function checkLogin() {
  const pass = document.getElementById('admin-pass').value;
  if(!SECURE_DATA) {
    if(pass === "14121992") { document.getElementById('login-screen').style.display='none'; document.getElementById('admin-panel').style.display='block'; } else alert("Senha incorreta");
    return;
  }
  const token = await decryptToken(SECURE_DATA.token, pass);
  if(token) {
    DECRYPTED_TOKEN = token; 
    document.getElementById('login-screen').style.display='none'; 
    document.getElementById('admin-panel').style.display='block';
    // Ao logar, busca a vers√£o privada (escrita) para garantir SHA
    await fetchSHAOnly();
    renderAdminLists(); renderSavedList();
  } else { alert("Senha incorreta."); }
}

function openGithubConfig() { document.getElementById('github-config').style.display='block'; }
async function generateSecureConfig() {
  const pass = document.getElementById('new-admin-pass').value; const user = document.getElementById('gh-user').value; const repo = document.getElementById('gh-repo').value; const token = document.getElementById('gh-token').value;
  if(!pass || !user || !repo || !token) return alert("Preencha todos os campos");
  const encToken = await encryptToken(token, pass);
  const data = { u: _obf(user), r: _obf(repo), token: encToken };
  const code = `const SECURE_DATA = ${JSON.stringify(data, null, 2)};`;
  document.getElementById('obfuscated-output').style.display='block'; document.getElementById('output-code').value = code;
}

function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); ['saved','situations','questions'].forEach(x=>document.getElementById(`tab-${x}`).style.display='none'); document.getElementById(`tab-${t}`).style.display='block'; }
function renderSavedList() { const el = document.getElementById('saved-list'); if(!savedLists.length) return el.innerHTML='<p style="padding:10px">Vazio</p>'; el.innerHTML = savedLists.map(i=>`<div class="list-row"><div><strong>${i.name}</strong><br><small>${i.updated}</small></div><div><button class="btn-sm btn-edit" onclick="loadChecklist(${i.id})">Abrir</button><button class="btn-sm btn-del" onclick="deleteSavedList(${i.id})">Excluir</button></div></div>`).join(''); }
function renderAdminLists() {
  document.getElementById('situations-list').innerHTML = appData.situations.map((s,i)=>`<div class="list-row"><strong>${s.label}</strong><div><button class="btn-sm btn-edit" onclick="editSituation(${i})">Edit</button><button class="btn-sm btn-del" onclick="delItem('situation',${i})">Del</button></div></div>`).join('');
  document.getElementById('questions-list').innerHTML = appData.questions.map((q,i)=>`<div class="list-row"><strong>${q.text}</strong><div><button class="btn-sm btn-edit" onclick="editQuestion(${i})">Edit</button><button class="btn-sm btn-del" onclick="delItem('question',${i})">Del</button></div></div>`).join('');
}
function editSituation(i) { setupEdit('situation',i); if(i!==-1) { document.getElementById('edit-label').value=appData.situations[i].label; document.getElementById('sit-docs').value=appData.situations[i].docs.join('\n'); } }
function editQuestion(i) { setupEdit('question',i); if(i!==-1) { document.getElementById('edit-label').value=appData.questions[i].text; appData.questions[i].options.forEach(o=>addOptionRow(o.label,o.docs.join('\n'))); } else addOptionRow('',''); }
function setupEdit(type, id) { document.getElementById('edit-overlay').style.display='block'; document.getElementById('edit-type').value=type; document.getElementById('edit-id').value=id; document.getElementById('situation-fields').style.display=type==='situation'?'block':'none'; document.getElementById('question-fields').style.display=type==='question'?'block':'none'; document.getElementById('options-container').innerHTML=''; document.getElementById('edit-label').value=''; document.getElementById('sit-docs').value=''; }
function addOptionRow(l='',d='') { document.getElementById('options-container').innerHTML+=`<div class="option-row" style="display:grid;grid-template-columns:1fr 2fr auto;gap:5px;margin-bottom:5px;"><input class="opt-label" value="${l}"><textarea class="doc-input">${d}</textarea><button onclick="this.parentElement.remove()">X</button></div>`; }
function cancelEdit() { document.getElementById('edit-overlay').style.display='none'; }
async function saveEdit() {
  const type=document.getElementById('edit-type').value, id=parseInt(document.getElementById('edit-id').value), label=document.getElementById('edit-label').value;
  if(type==='situation') { const d=document.getElementById('sit-docs').value.split('\n').filter(x=>x.trim()); const o={id:label.toLowerCase(),label,docs:d}; id===-1?appData.situations.push(o):appData.situations[id]=o; }
  else { const ops=[]; document.querySelectorAll('.option-row').forEach(r=>{ops.push({label:r.querySelector('.opt-label').value,docs:r.querySelector('.doc-input').value.split('\n').filter(x=>x.trim())})}); const o={id:'q'+Date.now(),text:label,options:ops}; id===-1?appData.questions.push(o):appData.questions[id]=o; }
  const ok = await pushToGithub(); if(ok) { renderAdminLists(); document.getElementById('edit-overlay').style.display='none'; }
}
async function delItem(t,i) { if(!confirm('Excluir e salvar na nuvem?')) return; t==='situation'?appData.situations.splice(i,1):appData.questions.splice(i,1); const ok = await pushToGithub(); if(ok) renderAdminLists(); }
</script>
</body>
</html>
