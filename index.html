<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checklist de Documentos - Cadastro √önico UFG</title>
<style>
    /* --- Estilos Visuais --- */
    :root {
        --primary: #0056b3;
        --primary-light: #007BFF;
        --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --surface: #ffffff;
        --text: #333333;
        --border: #e0e0e0;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --success: #28a745;
        --warning: #ffc107;
    }
    body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background-image: var(--bg-gradient);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .container {
        background: var(--surface);
        width: 100%;
        max-width: 850px;
        padding: 40px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        margin-bottom: 40px;
        position: relative;
    }

    h1 {
        color: var(--primary);
        text-align: center;
        margin-bottom: 10px;
        font-weight: 700;
        font-size: 1.8rem;
    }
    .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 1rem;
    }

    .alert {
        background: #eff6ff;
        border-left: 5px solid var(--primary-light);
        padding: 20px;
        font-size: 0.95rem;
        margin-bottom: 25px;
        line-height: 1.6;
    }
    .alert h4 {
        margin: 0 0 10px 0;
        color: var(--primary);
        font-size: 1.1rem;
    }

    .info-text {
        text-align: justify;
        margin-bottom: 15px;
        font-size: 0.95rem;
        line-height: 1.6;
        color: #444;
    }

    .section-header {
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
        margin: 30px 0 20px 0;
        color: var(--primary);
        font-size: 1.2rem;
        font-weight: 600;
    }
    label {
        display: block;
        font-weight: 600;
        color: #444;
        font-size: 0.9rem;
    }
    input[type="text"],
    input[type="number"],
    input[type="password"],
    select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        box-sizing: border-box;
        background: #fcfcfc;
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
    }
    input:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .btn-primary {
        background: var(--primary-light);
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        transition: background 0.3s, transform 0.2s;
    }
    .btn-primary:hover {
        background: var(--primary);
        transform: translateY(-2px);
    }
    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
        flex-wrap: wrap;
    }
    .btn-tool {
        padding: 10px 15px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .btn-print {
        background: #6c757d;
    }
    .btn-save {
        background: var(--success);
    }
    .btn-link {
        background: var(--warning);
        color: #333;
    }
    .btn-back {
        background: var(--primary);
    }

    #checklist-screen {
        display: none;
    }
    .person-block {
        margin-bottom: 25px;
        padding: 15px;
        border-left: 5px solid #0056b3;
        background-color: #fcfcfc;
        page-break-inside: avoid;
    }
    .checklist-content h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #333;
        font-size: 1.2rem;
        text-transform: uppercase;
    }
    .checklist-content ul {
        list-style: none;
        padding-left: 0;
        margin-top: 5px;
    }
    li.doc-item {
        position: relative;
        margin-bottom: 4px;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    li.doc-item:hover {
        background-color: #f0f0f0;
    }
    .doc-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        width: 100%;
    }
    .doc-checkbox {
        appearance: none;
        -webkit-appearance: none;
        min-width: 20px;
        width: 20px;
        height: 20px;
        border: 2px solid #000;
        margin-right: 12px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 2px;
        background: #fff;
        cursor: pointer;
        flex-shrink: 0;
    }
    .doc-checkbox:checked::after {
        content: "X";
        font-weight: 900;
        color: #000;
        font-size: 16px;
        line-height: 1;
        font-family: Arial, sans-serif;
    }
    .doc-text {
        flex: 1;
        line-height: 1.4;
        word-break: break-word;
    }
    .doc-text a {
        color: #0056b3;
        font-weight: bold;
        text-decoration: underline;
    }
    .doc-text a:hover {
        color: #003d80;
    }
    .btn-remove {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        z-index: 10;
    }
    li.doc-item:hover .btn-remove {
        display: block;
    }
    .extra-docs {
        background: #fffbe6;
        padding: 15px;
        border: 1px solid #ffe58f;
        border-radius: 4px;
        margin-top: 20px;
    }

    .add-doc-row {
        display: flex;
        gap: 5px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #ccc;
    }
    .add-doc-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    .btn-add-item {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0 15px;
        cursor: pointer;
        font-weight: bold;
    }

    footer {
        text-align: center;
        margin-top: auto;
        padding: 20px;
        font-size: 0.8rem;
    }
    .admin-link {
        color: #aaa;
        text-decoration: none;
    }
    #admin-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        overflow-y: auto;
    }
    .admin-content {
        background: white;
        margin: 30px auto;
        padding: 30px;
        width: 90%;
        max-width: 900px;
        border-radius: 12px;
        position: relative;
    }
    .admin-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
        overflow-x: auto;
    }
    .tab-btn {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
        white-space: nowrap;
    }
    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    .item-list {
        border: 1px solid #eee;
        border-radius: 8px;
        max-height: 400px;
        overflow-y: auto;
    }
    .list-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        background: #fff;
    }
    .btn-sm {
        padding: 5px 10px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        margin-left: 5px;
    }
    .btn-edit {
        background: #ffc107;
        color: #333;
    }
    .btn-del {
        background: #dc3545;
        color: white;
    }
    .btn-add {
        background: #28a745;
        color: white;
    }

    .dropdown-container {
        position: relative;
        user-select: none;
    }
    .dropdown-trigger {
        background: #fff;
        border: 1px solid var(--border);
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 21px;
    }
    .dropdown-trigger::after {
        content: "";
        border: 5px solid transparent;
        border-top-color: #666;
        margin-left: 10px;
    }
    .dropdown-menu {
        position: absolute;
        top: 105%;
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        z-index: 100;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        padding-top: 5px;
    }
    .dropdown-menu.show {
        display: block;
    }
    .dropdown-item {
        padding: 10px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
    }
    .dropdown-item:hover {
        background-color: #f0f7ff;
    }
    .dropdown-item input[type="checkbox"] {
        margin-right: 12px;
        transform: scale(1.2);
        cursor: pointer;
    }
    .dropdown-ok {
        padding: 8px;
        border-top: 1px solid #eee;
        position: sticky;
        bottom: 0;
        background: white;
        text-align: center;
    }
    .dropdown-ok button {
        background: var(--success);
        color: white;
        border: none;
        padding: 6px 0;
        width: 100%;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.85rem;
    }
    .dropdown-ok button:hover {
        background: #218838;
    }

    #loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 3000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0056b3;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    @media print {
        body {
            padding: 0;
            font-size: 12pt;
            background: white;
        }
        .container {
            box-shadow: none;
            padding: 0;
            max-width: 100%;
        }
        .toolbar,
        footer,
        #creation-screen,
        #loading-overlay,
        .add-doc-row {
            display: none !important;
        }
        #checklist-screen {
            display: block !important;
        }
        .btn-remove {
            display: none !important;
        }
        li.doc-item:hover {
            background-color: transparent;
        }
        .person-block {
            border-left-width: 2px;
        }
        .doc-checkbox {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            border-color: #000 !important;
        }
        .doc-checkbox:checked::after {
            color: #000 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>

</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-text" style="margin-top:15px; font-weight:bold; color:#0056b3;">Carregando dados...</p>
  </div>

  <div class="container">
    <div id="creation-screen">
      <h1>Gerador de Checklist</h1>
      <div class="subtitle">Documentos para inscri√ß√£o no Cadastro √önico de Bolsas da UFG</div>
      
      <div class="alert">
        <h4>Aten√ß√£o</h4>
        Este gerador de checklist visa facilitar a identifica√ß√£o dos documentos necess√°rios para inscri√ß√£o no Cadastro √önico de Bolsas da UFG, considerando a realidade socioecon√¥mica de cada estudante; entretanto, <strong>n√£o substitui a leitura cuidadosa da Rela√ß√£o de Documentos do edital.</strong>
      </div>

      <div class="info-text">
        <strong>Defini√ß√£o de Grupo Familiar:</strong> √© considerado grupo familiar todas as pessoas que moram com voc√™, que dividem ou n√£o a mesma renda, eventualmente ampliada por outras pessoas que contribuam para o rendimento ou tenham suas despesas atendidas por aquela unidade familiar, todas moradoras em um mesmo domic√≠lio.
      </div>

      <div class="info-text" style="margin-bottom:30px;">
        <strong>Importante:</strong> o/a estudante que se define como √∫nico membro do grupo familiar e n√£o possua rendimento pr√≥prio suficiente para a sua subsist√™ncia dever√° informar o grupo familiar de origem, ainda que residente em local diverso do seu domic√≠lio.
      </div>

      <div id="step-1">
        <label for="family-size">Quantidade de pessoas no grupo familiar (al√©m do estudante):</label>
        <div style="display: flex; gap: 10px;">
          <input type="number" id="family-size" min="0" value="0">
          <button class="btn-primary" style="width: auto; margin-top:0;" onclick="renderForm()">Iniciar</button>
        </div>
      </div>
      <div id="form-container"></div>
    </div>

    <div id="checklist-screen">
      <div class="toolbar">
        <button class="btn-tool btn-back" onclick="closeChecklist()">‚¨Ö Voltar / Novo</button>
        <button class="btn-tool btn-save" onclick="manualSave()">üíæ Salvar</button>
        <button class="btn-tool btn-link" onclick="copyLink()">üîó Copiar Link</button>
        <button class="btn-tool btn-print" onclick="printAndSaveToCloud()">üñ®Ô∏è Imprimir / PDF</button>
      </div>
      <h1 style="border-bottom: 2px solid #ddd; padding-bottom: 10px;">Checklist de Documentos - Cadastro √önico UFG</h1>

   <div class="alert">
        <h4>Instru√ß√µes:</h4>
        <strong>a)</strong> N√£o √© necess√°rio que as declara√ß√µes estejam autenticadas, mas √© preciso que o declarante assine como no RG, que deve acompanhar as declara√ß√µes;</br>

		<strong>b)</strong> No caso de extratos banc√°rios emitidos via Internet que n√£o contenham o nome do titular da conta, o estudante dever√° identificar;</br>

		<strong>c)</strong> Em casos extremos, em que n√£o seja poss√≠vel apresentar um determinado documento, poder√° ser apresentada uma declara√ß√£o de aus√™ncia, devidamente justificada e comprovada.
    </div>
      
      <div id="checklist-content" class="checklist-content"></div>
    </div>
  </div>

  <footer>
    <div id="status-bar" style="margin-bottom:10px; font-size:0.8rem; color:#666;"></div>
    <a href="#" class="admin-link" onclick="openAdmin()">√Årea Administrativa</a>
  </footer>

  <div id="admin-modal">
    <div class="admin-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; color:var(--primary);">Painel Administrativo</h2>
        <button class="btn-sm" onclick="closeAdmin()" style="background:#666; color:white;">Fechar</button>
      </div>

      <div id="login-screen">
        <label>Senha de Acesso:</label>
        <div style="display:flex; gap:10px;">
          <input type="password" id="admin-pass" placeholder="Sua senha de admin">
          <button class="btn-sm btn-primary" style="margin:0; width:auto;" onclick="checkLogin()">Entrar</button>
        </div>
        <p style="font-size:0.8rem; color:#666; margin-top:10px;">Acesso √† √°rea de administra√ß√£o</p>
      </div>

      <div id="admin-panel" style="display:none;">
        <div class="admin-tabs">
          <button class="tab-btn active" onclick="switchTab('saved')">Listas Geradas</button>
          <button class="tab-btn" onclick="switchTab('situations')">Situa√ß√µes</button>
          <button class="tab-btn" onclick="switchTab('questions')">Perguntas</button>
          <button class="tab-btn" onclick="openGithubConfig()" style="color:#24292e;">Configura√ß√µes</button>
        </div>

        <div id="tab-saved">
          <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <input type="text" id="search-candidate" placeholder="üîç Buscar estudante por nome..." onkeyup="filterCandidates()" style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          <div class="item-list" id="saved-list"></div>
        </div>

        <div id="tab-situations" style="display:none;">
          <button class="btn-sm btn-add" onclick="editSituation(-1)">+ Nova Situa√ß√£o</button>
          <div class="item-list" id="situations-list" style="margin-top:10px;"></div>
        </div>

        <div id="tab-questions" style="display:none;">
          <button class="btn-sm btn-add" onclick="editQuestion(-1)">+ Nova Pergunta</button>
          <div class="item-list" id="questions-list" style="margin-top:10px;"></div>
        </div>

        <div id="github-config" style="display:none; margin-top:20px; padding:20px; border:1px solid #ccc; background:#f9f9f9; border-radius:8px;">
          <h3>Configura√ß√£o do GitHub</h3>
          <p style="font-size:0.85rem;">Insira seus dados para gerar o c√≥digo seguro.</p>
          <label>Senha de Admin (Definir nova):</label><input type="text" id="new-admin-pass" placeholder="Ex: 14121992">
          <label>Usu√°rio GitHub:</label><input type="text" id="gh-user">
          <label>Nome do Reposit√≥rio:</label><input type="text" id="gh-repo">
          <label>Token:</label><input type="password" id="gh-token">
          <div style="margin-top:10px; display:flex; gap:10px;">
             <button class="btn-primary" style="margin:0; background:#24292e;" onclick="generateConfig()">Gerar C√≥digo</button>
             <button class="btn-sm" onclick="document.getElementById('github-config').style.display='none'">Cancelar</button>
          </div>
          <div id="obfuscated-output" style="display:none; margin-top:15px;">
            <label>Substitua a vari√°vel `var GLOBAL_CONFIG` no topo do script por este bloco:</label>
            <textarea id="output-code" style="width:100%; height:80px; font-family:monospace; font-size:0.8rem;"></textarea>
          </div>
        </div>

        <div id="edit-overlay" style="display:none; margin-top:20px; padding-top:20px; border-top:2px dashed #ccc;">
          <h3 id="edit-title">Editar</h3>
          <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
          <label>T√≠tulo:</label><input type="text" id="edit-label">
          <div id="situation-fields" style="display:none;">
            <label>Documentos:</label>
            <p style="font-size:0.8em; color:#666; margin:0 0 5px 0;">Para incluir link, use: <b>[Texto do Link](http://site.com)</b></p>
            <textarea id="sit-docs" style="width:100%; min-height:150px;"></textarea>
          </div>
          <div id="question-fields" style="display:none;"><label>Op√ß√µes:</label><div id="options-container"></div><button class="btn-sm btn-add" onclick="addOptionRow()">+ Op√ß√£o</button></div>
          <div style="margin-top:15px; display:flex; gap:10px;"><button class="btn-primary" onclick="saveEdit()">Salvar na Nuvem</button><button class="btn-sm" style="background:#999; color:white;" onclick="cancelEdit()">Cancelar</button></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==========================================================================
   CONFIGURA√á√ÉO GITHUB & SEGURAN√áA (IIFE OBFUSCADA)
   ========================================================================== */
var GLOBAL_CONFIG = {
  "u": "JCw/OD4rKisx",
  "r": "MCE2NjQkIDcwMSssPyA=",
  "t": "NCAnPSoqFjQlMRFuegRvDGFqZxhjBQ8LOg0Kcww6Mg0AACZ6ZQdgYwwiBQBxEjo2KQsyLSZRJQw1Dzd5GCZ3ICkJAyJqa2N+AjEJFBMDCxIHcg0QH3AYO2NEIjkn",
  "h": "d5a7d040e8c9a049f1b2ebdaa96fb34ea6f9a67197a7b27c0fe387db70e55bef"
};

/* ==========================================================================
   MODULO DE NUVEM SEGURO (CloudManager)
   Este m√≥dulo usa uma closure para esconder as chaves da janela global.
   ========================================================================== */
const CloudManager = (function() {
  let _u = ""; 
  let _r = "";
  let _t = "";
  let _h = ""; 
  
  function _decode(s) {
    if(!s) return "";
    try {
      let d = atob(s);
      let r = "";
      const k = "SISU_HIDDEN_KEY_V2";
      for (let i = 0; i < d.length; i++) {
        r += String.fromCharCode(d.charCodeAt(i) ^ k.charCodeAt(i % k.length));
      }
      return r;
    } catch(e) { return ""; }
  }

  function init() {
    if (typeof GLOBAL_CONFIG !== 'undefined' && GLOBAL_CONFIG) {
      _u = _decode(GLOBAL_CONFIG.u);
      _r = _decode(GLOBAL_CONFIG.r);
      _t = _decode(GLOBAL_CONFIG.t);
      _h = GLOBAL_CONFIG.h; 
      try { delete window.GLOBAL_CONFIG; } catch(e) { window.GLOBAL_CONFIG = null; }
      console.log("Sistema de nuvem inicializado de forma segura.");
      return true;
    }
    return false;
  }

  function isReady() { return _u && _r && _t; }

  async function checkPass(inputPass) {
    const msgBuffer = new TextEncoder().encode(inputPass);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex === _h;
  }

  async function fetchDB() {
    if(!isReady()) throw new Error("Cloud n√£o configurada.");
    const url = `https://api.github.com/repos/${_u}/${_r}/contents/database.json`;
    const resp = await fetch(url, { headers: { 'Authorization': `token ${_t}`, 'Accept': 'application/vnd.github.v3+json' } });
    if(resp.ok) {
      const json = await resp.json();
      const content = JSON.parse(decodeURIComponent(escape(atob(json.content))));
      return { data: content, sha: json.sha };
    } else if(resp.status === 404) {
      return { data: null, sha: null }; 
    }
    throw new Error("Erro GitHub: " + resp.status);
  }

  async function saveDB(data, sha) {
    if(!isReady()) throw new Error("Cloud n√£o configurada.");
    const url = `https://api.github.com/repos/${_u}/${_r}/contents/database.json`;
    const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    const body = { message: "Update SISU Data " + new Date().toISOString(), content: contentBase64 };
    if(sha) body.sha = sha;

    const resp = await fetch(url, {
      method: 'PUT',
      headers: { 'Authorization': `token ${_t}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if(!resp.ok) throw new Error("Erro ao salvar: " + resp.status);
    return await resp.json();
  }

  function generateCode(user, repo, token, passHash) {
    const k = "SISU_HIDDEN_KEY_V2";
    function _enc(s) {
      let r = "";
      for (let i = 0; i < s.length; i++) {
        r += String.fromCharCode(s.charCodeAt(i) ^ k.charCodeAt(i % k.length));
      }
      return btoa(r);
    }
    return { u: _enc(user), r: _enc(repo), t: _enc(token), h: passHash };
  }

  return { init, isReady, checkPass, fetch: fetchDB, save: saveDB, generateCode };
})();

const isCloudConfigured = CloudManager.init();

/* ==========================================================================
   DADOS E ESTADO DA APP
   ========================================================================== */
const defaultData = {
  situations: [
    { id: 'assalariado', label: 'Assalariado', docs: ['Contracheques (Out, Nov, Dez 2025)', 'CTPS completa', 'IRPF 2025 (se declarou)'] },
    { id: 'autonomo', label: 'Aut√¥nomo/Informal', docs: ['Declara√ß√£o de Aut√¥nomo', 'CTPS', 'Extratos banc√°rios'] },
    { id: 'aposentado', label: 'Aposentado/Pensionista', docs: ['Extrato do benef√≠cio', 'IRPF 2025'] },
    { id: 'mei', label: 'Microempreendedor (MEI)', docs: ['DASN Simei', 'Declara√ß√£o de MEI', 'Extratos'] },
    { id: 'desempregado', label: 'Desempregado', docs: ['CTPS (Baixa)', 'Declara√ß√£o de desemprego', 'Seguro-desemprego (se houver)'] },
    { id: 'nunca', label: 'Nunca Trabalhou', docs: ['CTPS (em branco)', 'CNIS (se maior de 18)'] }
  ],
  questions: [
    { id: 'moradia', text: 'Moradia', options: [ { label: 'Alugada', docs: ['Contrato de loca√ß√£o ou recibos.'] }, { label: 'Cedida', docs: ['Declara√ß√£o de im√≥vel cedido.'] }, { label: 'Financiada', docs: ['Comprovante da presta√ß√£o.'] }, { label: 'Pr√≥pria', docs: [] } ]},
    { id: 'orfao', text: '√â solteiro(a) com pais falecidos?', options: [ { label: 'Sim', docs: ['Certid√£o de √≥bito pai/m√£e.'] }, { label: 'N√£o', docs: [] } ]},
    { id: 'aluguel', text: 'Renda de aluguel?', options: [ { label: 'Sim', docs: ['Contratos e recibos de aluguel.'] }, { label: 'N√£o', docs: [] } ]},
    { id: 'rural', text: 'Propriet√°rio rural?', options: [ { label: 'Sim', docs: ['Escritura/INCRA', 'DITR 2025'] }, { label: 'N√£o', docs: [] } ]}
  ]
};

let appData = defaultData;
let savedLists = [];
let currentSHA = null;
let currentChecklistId = null; 
let isDirty = false; 

window.addEventListener('beforeunload', (e) => { if (isDirty) { e.preventDefault(); e.returnValue = 'Altera√ß√µes n√£o salvas.'; } });

/* ==========================================================================
   CARREGAMENTO E SINCRONIZA√á√ÉO
   ========================================================================== */
window.onload = async function() {
  if(isCloudConfigured) {
    await syncData();
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if(id) loadChecklist(parseInt(id));
  } else {
    document.getElementById('status-bar').textContent = "‚ö†Ô∏è Nuvem n√£o configurada. Use o menu Admin.";
  }
};

async function syncData() {
  showLoading('Sincronizando...');
  try {
    const res = await CloudManager.fetch();
    if(res.data) {
      appData = res.data.appData || defaultData;
      savedLists = res.data.savedLists || [];
      currentSHA = res.sha;
      document.getElementById('status-bar').textContent = "‚úÖ Tudo ok!";
    } else {
      document.getElementById('status-bar').textContent = "‚ÑπÔ∏è Reposit√≥rio conectado. Arquivo ser√° criado ao salvar.";
    }
  } catch(e) {
    alert("Erro de conex√£o: " + e.message);
  } finally {
    hideLoading();
  }
}

async function saveDataToCloud() {
  if(!isCloudConfigured) return alert("Erro: Nuvem n√£o configurada.");
  showLoading('Salvando...');
  
  try {
    const res = await CloudManager.fetch();
    if(res.data) {
      currentSHA = res.sha;
      const remoteLists = res.data.savedLists || [];
    }
  } catch(e) { console.log("Criando novo arquivo..."); }

  try {
    const payload = { appData, savedLists };
    const res = await CloudManager.save(payload, currentSHA);
    currentSHA = res.content.sha;
    document.getElementById('status-bar').textContent = "‚úÖ Salvo √†s " + new Date().toLocaleTimeString();
    return true;
  } catch(e) {
    alert("Falha ao salvar: " + e.message);
    return false;
  } finally {
    hideLoading();
  }
}

/* ==========================================================================
   L√ìGICA UI
   ========================================================================== */
function showLoading(msg) { document.getElementById('loading-text').textContent=msg; document.getElementById('loading-overlay').style.display='flex'; }
function hideLoading() { document.getElementById('loading-overlay').style.display='none'; }

function createMultiSelect(id, items) {
  const c = document.createElement('div'); c.className = 'dropdown-container'; c.id = `container-${id}`;
  const t = document.createElement('div'); t.className = 'dropdown-trigger'; t.innerHTML = '<span class="trigger-text">Selecione todas as situa√ß√µes aplic√°veis...</span>';
  t.onclick = (e) => { e.stopPropagation(); toggleDropdown(id); };
  const m = document.createElement('div'); m.className = 'dropdown-menu'; m.id = `menu-${id}`;
  items.forEach(i => {
    const r = document.createElement('label'); r.className = 'dropdown-item';
    r.innerHTML = `<input type="checkbox" value="${i.id}" onchange="updateTrigger('${id}')">${i.label}`;
    r.onclick = (e) => e.stopPropagation(); m.appendChild(r);
  });
  const okDiv = document.createElement('div'); okDiv.className = 'dropdown-ok';
  okDiv.innerHTML = '<button type="button">OK - Concluir</button>';
  okDiv.onclick = (e) => { e.stopPropagation(); toggleDropdown(id); };
  m.appendChild(okDiv);
  c.appendChild(t); c.appendChild(m); return c;
}
function toggleDropdown(id) { document.querySelectorAll('.dropdown-menu').forEach(m => { if(m.id !== `menu-${id}`) m.classList.remove('show'); }); document.getElementById(`menu-${id}`).classList.toggle('show'); }
function updateTrigger(id) {
  const c = document.getElementById(`container-${id}`); const ch = c.querySelectorAll('input:checked'); const s = c.querySelector('.trigger-text');
  s.textContent = !ch.length ? 'Selecione...' : Array.from(ch).map(x=>x.parentNode.textContent.trim()).join(', ');
  s.style.color = !ch.length ? '#666' : '#000';
}
document.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show')));

function renderForm() {
  const c = document.getElementById('form-container'); const s = parseInt(document.getElementById('family-size').value);
  if(isNaN(s)||s<0) return alert('Inv√°lido');
  c.innerHTML = ''; c.appendChild(createMemberCard('Estudante',0,true));
  for(let i=1; i<=s; i++) c.appendChild(createMemberCard(`${i}¬∫ Membro do grupo familiar`,i,false));
  const b = document.createElement('button'); b.className = 'btn-primary'; b.textContent = 'Gerar Checklist'; b.onclick = generateChecklist; c.appendChild(b);
}
function createMemberCard(title, i, isCand) {
  const card = document.createElement('div'); card.style.cssText = 'background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:20px; margin-top:20px;';
  let h = `<div class="section-header" style="margin-top:0;">${title}</div><div style="margin-bottom:15px;"><label>Nome:</label><input type="text" id="name-${i}"></div><div style="margin-bottom:15px;"><label>Situa√ß√£o:</label><div id="sit-wrapper-${i}"></div></div>`;
  if(isCand) {
    h+=`<div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;"><h4 style="color:#666;">Informa√ß√µes complementares</h4>`;
    appData.questions.forEach((q,qi) => {
      let o = `<option value="">Escolha...</option>`; q.options.forEach((opt,oi)=> o+=`<option value="${qi}-${oi}">${opt.label}</option>`);
      h+=`<div style="margin-bottom:15px;"><label>${q.text}</label><select id="extra-${qi}">${o}</select></div>`;
    }); h+='</div>';
  }
  card.innerHTML = h; card.querySelector(`#sit-wrapper-${i}`).appendChild(createMultiSelect(`multi-${i}`, appData.situations)); return card;
}

function markDirty() { isDirty = true; }
function removeDoc(btn) { btn.parentElement.remove(); markDirty(); }
function addNewDoc(btn) {
  const input = btn.previousElementSibling; const text = input.value.trim(); if(!text) return;
  const ul = btn.closest('div').previousElementSibling; 
  const li = document.createElement('li'); li.className = 'doc-item';
  li.innerHTML = `<label class="doc-label"><input type="checkbox" class="doc-checkbox" onchange="markDirty()"><span class="doc-text">${formatDocText(text)}</span></label><button class="btn-remove" onclick="removeDoc(this)">X</button>`;
  ul.appendChild(li); input.value = ''; markDirty();
}

function addNewObs(btn) {
  const input = btn.previousElementSibling; 
  const text = input.value.trim(); 
  if(!text) return;
  
  const ul = btn.closest('div').previousElementSibling; // Pega o UL acima
  const li = document.createElement('li'); 
  li.className = 'doc-item';
  
  li.innerHTML = `
    <div style="padding: 5px 30px 5px 5px;">
      <span class="doc-text" style="display:block;">${formatDocText(text)}</span>
    </div>
    <button class="btn-remove" onclick="removeDoc(this)">X</button>
  `;
  
  ul.appendChild(li); 
  input.value = ''; 
  markDirty();
}

function formatDocText(text) {
  let clean = text.replace(/^[\(\s\)]+/, '').trim();
  return clean.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">$1</a>');
}

function generateChecklist() {
  const size = parseInt(document.getElementById('family-size').value);
  const item = t => `<li class="doc-item"><label class="doc-label"><input type="checkbox" class="doc-checkbox" onchange="markDirty()"><span class="doc-text">${formatDocText(t)}</span></label><button class="btn-remove" onclick="removeDoc(this)">X</button></li>`;
  const addBox = `<div class="add-doc-row"><input type="text" class="add-doc-input" placeholder="Adicionar documento..."><button class="btn-add-item" onclick="addNewDoc(this)">+</button></div>`;

  let html = '', cName = '';
  for(let i=0; i<=size; i++) {
    const n = document.getElementById(`name-${i}`).value.trim();
    if(!n && i===0) return alert('Nome do estudante obrigat√≥rio'); if(!n) continue; if(i===0) cName = n;
    const ch = document.querySelectorAll(`#container-multi-${i} input:checked`);
    
    html += `<div class="person-block"><h3>${i===0?'Estudante':'Familiar'}: ${n}</h3><strong>B√°sicos:</strong><ul>${item('RG e CPF')}${i===0?item('Declara√ß√£o Composi√ß√£o Familiar'):''}${item('Extratos Banc√°rios')}${item('Registrato (BACEN)')}</ul>`;
    
    if(ch.length) { html+='<strong>Espec√≠ficos:</strong><ul>'; let d=[]; ch.forEach(c=>{ const s=appData.situations.find(x=>x.id===c.value); if(s) d.push(...s.docs); }); [...new Set(d)].forEach(x=>html+=item(x)); html+='</ul>'; }
    else html+='<p style="font-style:italic;color:#666">Nenhuma situa√ß√£o.</p>';
    html += addBox + '</div>';
  }
  let extra=''; appData.questions.forEach((q,qi)=>{ const v=document.getElementById(`extra-${qi}`).value; if(v){ const[x,y]=v.split('-'); const op=appData.questions[x].options[y]; if(op.docs.length) extra+=op.docs.map(d=>item(d)).join(''); }});
	html+=`<div class="extra-docs"><h3>Complementar</h3><ul>${extra}</ul>${addBox}</div>`;
  
  const addObsBox = `<div class="add-doc-row"><input type="text" class="add-doc-input" placeholder="Adicionar observa√ß√£o..."><button class="btn-add-item" onclick="addNewObs(this)">+</button></div>`;
  
  // Cria um bloco cinza para diferenciar dos blocos de pessoas
  html += `<div class="person-block" style="border-left-color: #666; margin-top: 20px;">
             <h3>Observa√ß√µes</h3>
             <ul></ul>
             ${addObsBox}
           </div>`;
  
  const content = document.getElementById('checklist-content'); content.innerHTML = html; content.dataset.candidate = cName;
  currentChecklistId = null; updateUrl(null); isDirty = true; 
  document.getElementById('creation-screen').style.display='none'; document.getElementById('checklist-screen').style.display='block'; window.scrollTo(0,0);
}

function closeChecklist() { 
  if(isDirty && !confirm("Existem altera√ß√µes n√£o salvas. Deseja realmente voltar?")) return;
  document.getElementById('checklist-screen').style.display='none'; document.getElementById('creation-screen').style.display='block'; 
  currentChecklistId=null; isDirty = false; updateUrl(null);
}
function updateUrl(id) { const url = new URL(window.location); if(id) url.searchParams.set('id', id); else url.searchParams.delete('id'); window.history.pushState({}, '', url); }

/* === SALVAR / CARREGAR === */
async function saveLogic(silent = false) {
  const div = document.getElementById('checklist-content');
  const name = div.dataset.candidate || 'Sem Nome';
  div.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked ? c.setAttribute('checked','checked') : c.removeAttribute('checked'));
  const html = div.innerHTML;
  if(currentChecklistId) {
    const idx = savedLists.findIndex(l=>l.id===currentChecklistId);
    if(idx!==-1) { savedLists[idx].html=html; savedLists[idx].updated=new Date().toLocaleString(); }
  } else {
    const newId = Date.now();
    savedLists.push({ id:newId, name, html, created:new Date().toLocaleString(), updated:new Date().toLocaleString() });
    currentChecklistId = newId; updateUrl(newId);
  }
  const success = await saveDataToCloud();
  if(success) { isDirty = false; if(!silent) alert("Salvo com sucesso!"); }
  return success;
}
async function manualSave() { await saveLogic(false); }
async function printAndSaveToCloud() { await saveLogic(true); setTimeout(() => window.print(), 200); }

async function loadChecklist(id) {
  if(isDirty && !confirm("Altera√ß√µes n√£o salvas ser√£o perdidas. Continuar?")) return;
  await syncData();
  const l = savedLists.find(x=>x.id===id); 
  if(!l) { alert('Checklist n√£o encontrado.'); updateUrl(null); return; }
  const c = document.getElementById('checklist-content'); c.innerHTML=l.html; c.dataset.candidate=l.name;
  currentChecklistId=l.id; isDirty = false; updateUrl(l.id); 
  closeAdmin(); document.getElementById('creation-screen').style.display='none'; document.getElementById('checklist-screen').style.display='block';
}
function copyLink() { if(!currentChecklistId || isDirty) return alert("Salve primeiro."); navigator.clipboard.writeText(window.location.href).then(()=>alert("Link copiado!")); }
async function deleteSavedList(id) { if(!confirm('Excluir?')) return; savedLists = savedLists.filter(x=>x.id!==id); const ok = await saveDataToCloud(); if(ok) renderSavedList(); }

/* === FILTRAR ESTUDANTES (NOVA FUN√á√ÉO) === */
function filterCandidates() {
  const filter = document.getElementById('search-candidate').value.toLowerCase();
  const rows = document.getElementById('saved-list').getElementsByClassName('list-row');
  for (let i = 0; i < rows.length; i++) {
    const text = rows[i].innerText.toLowerCase();
    rows[i].style.display = text.indexOf(filter) > -1 ? "" : "none";
  }
}

/* === ADMIN === */
function openAdmin() { document.getElementById('admin-modal').style.display='block'; if(!isCloudConfigured) openGithubConfig(); }
function closeAdmin() { document.getElementById('admin-modal').style.display='none'; document.getElementById('login-screen').style.display='block'; document.getElementById('admin-panel').style.display='none'; document.getElementById('admin-pass').value=''; }

async function checkLogin() {
  const pass = document.getElementById('admin-pass').value;
  if(!isCloudConfigured) {
    if(pass === "14121992") { document.getElementById('login-screen').style.display='none'; document.getElementById('admin-panel').style.display='block'; } else alert("Senha incorreta");
    return;
  }
  const isValid = await CloudManager.checkPass(pass);
  if(isValid) {
    document.getElementById('login-screen').style.display='none'; document.getElementById('admin-panel').style.display='block';
    renderAdminLists(); renderSavedList();
  } else { alert("Senha incorreta."); }
}

function openGithubConfig() { document.getElementById('github-config').style.display='block'; }
async function generateConfig() {
  const pass = document.getElementById('new-admin-pass').value; const user = document.getElementById('gh-user').value; const repo = document.getElementById('gh-repo').value; const token = document.getElementById('gh-token').value;
  if(!pass || !user || !repo || !token) return alert("Preencha todos os campos");
  const msgBuffer = new TextEncoder().encode(pass);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
  const codeObj = CloudManager.generateCode(user, repo, token, hashHex);
  const code = `var GLOBAL_CONFIG = ${JSON.stringify(codeObj, null, 2)};`;
  document.getElementById('obfuscated-output').style.display='block'; document.getElementById('output-code').value = code;
}

function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); ['saved','situations','questions'].forEach(x=>document.getElementById(`tab-${x}`).style.display='none'); document.getElementById(`tab-${t}`).style.display='block'; }
function renderSavedList() { const el = document.getElementById('saved-list'); if(!savedLists.length) return el.innerHTML='<p style="padding:10px">Vazio</p>'; el.innerHTML = savedLists.map(i=>`<div class="list-row"><div><strong>${i.name}</strong><br><small>${i.updated}</small></div><div><button class="btn-sm btn-edit" onclick="loadChecklist(${i.id})">Abrir</button><button class="btn-sm btn-del" onclick="deleteSavedList(${i.id})">X</button></div></div>`).join(''); }
function renderAdminLists() {
  document.getElementById('situations-list').innerHTML = appData.situations.map((s,i)=>`<div class="list-row"><strong>${s.label}</strong><div><button class="btn-sm btn-edit" onclick="editSituation(${i})">Editar</button><button class="btn-sm btn-del" onclick="delItem('situation',${i})">X</button></div></div>`).join('');
  document.getElementById('questions-list').innerHTML = appData.questions.map((q,i)=>`<div class="list-row"><strong>${q.text}</strong><div><button class="btn-sm btn-edit" onclick="editQuestion(${i})">Editar</button><button class="btn-sm btn-del" onclick="delItem('question',${i})">X</button></div></div>`).join('');
}
function editSituation(i) { setupEdit('situation',i); if(i!==-1) { document.getElementById('edit-label').value=appData.situations[i].label; document.getElementById('sit-docs').value=appData.situations[i].docs.join('\n'); } }
function editQuestion(i) { setupEdit('question',i); if(i!==-1) { document.getElementById('edit-label').value=appData.questions[i].text; appData.questions[i].options.forEach(o=>addOptionRow(o.label,o.docs.join('\n'))); } else addOptionRow('',''); }
function setupEdit(type, id) { document.getElementById('edit-overlay').style.display='block'; document.getElementById('edit-type').value=type; document.getElementById('edit-id').value=id; document.getElementById('situation-fields').style.display=type==='situation'?'block':'none'; document.getElementById('question-fields').style.display=type==='question'?'block':'none'; document.getElementById('options-container').innerHTML=''; document.getElementById('edit-label').value=''; document.getElementById('sit-docs').value=''; }
function addOptionRow(l='',d='') { document.getElementById('options-container').innerHTML+=`<div class="option-row" style="display:grid;grid-template-columns:1fr 2fr auto;gap:5px;margin-bottom:5px;"><input class="opt-label" value="${l}"><textarea class="doc-input">${d}</textarea><button onclick="this.parentElement.remove()">X</button></div>`; }
function cancelEdit() { document.getElementById('edit-overlay').style.display='none'; }
async function saveEdit() {
  const type=document.getElementById('edit-type').value, id=parseInt(document.getElementById('edit-id').value), label=document.getElementById('edit-label').value;
  if(type==='situation') { const d=document.getElementById('sit-docs').value.split('\n').filter(x=>x.trim()); const o={id:label.toLowerCase(),label,docs:d}; id===-1?appData.situations.push(o):appData.situations[id]=o; }
  else { const ops=[]; document.querySelectorAll('.option-row').forEach(r=>{ops.push({label:r.querySelector('.opt-label').value,docs:r.querySelector('.doc-input').value.split('\n').filter(x=>x.trim())})}); const o={id:'q'+Date.now(),text:label,options:ops}; id===-1?appData.questions.push(o):appData.questions[id]=o; }
  const ok = await saveDataToCloud(); if(ok) { renderAdminLists(); document.getElementById('edit-overlay').style.display='none'; }
}
async function delItem(t,i) { if(!confirm('Excluir e salvar na nuvem?')) return; t==='situation'?appData.situations.splice(i,1):appData.questions.splice(i,1); const ok = await saveDataToCloud(); if(ok) renderAdminLists(); }
</script>
</body>
</html>















