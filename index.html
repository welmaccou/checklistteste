<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title-tag">Checklist de Documentos - Cadastro √önico UFG</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* --- Estilos Visuais --- */
        :root {
            --primary: #0056b3;
            --primary-light: #007BFF;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --surface: #ffffff;
            --text: #333333;
            --border: #e0e0e0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --success: #28a745;
            --warning: #ffc107;
        }

        body {
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            background-image: var(--bg-gradient);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: var(--surface);
            width: 100%;
            max-width: 850px;
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            position: relative;
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 1.8rem;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .alert {
            background: #eff6ff;
            border-left: 5px solid var(--primary-light);
            padding: 20px;
            font-size: 0.95rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .extra-docs ul {
        list-style: none !important; 
        padding-left: 0 !important;  
        margin: 5px 0 !important;    
    }

    .extra-docs li.doc-item {
        margin-bottom: 4px;          
        padding: 4px;
    }

        .alert h4 {
            margin: 0 0 10px 0;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .info-text {
            text-align: justify;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #444;
        }

        .section-header {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin: 30px 0 20px 0;
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        label {
            display: block;
            font-weight: 600;
            color: #444;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
            background: #fcfcfc;
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .btn-primary {
            background: var(--primary-light);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background 0.3s, transform 0.2s;
        }

        .btn-primary:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .btn-primary2 {
            background: var(--primary-light);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s, transform 0.2s;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-tool {
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-print {
            background: #6c757d;
        }

        .btn-save {
            background: var(--success);
        }

        .btn-link {
            background: var(--warning);
            color: #333;
        }

        .btn-back {
            background: var(--primary);
        }

        #checklist-screen {
            display: none;
        }

        .person-block {
            margin-bottom: 25px;
            padding: 15px;
            border-left: 5px solid #0056b3;
            background-color: #fcfcfc;
            page-break-inside: avoid;
        }

        .checklist-content h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.2rem;
            text-transform: uppercase;
        }

        .checklist-content ul {
            list-style: none;
            padding-left: 0;
            margin-top: 5px;
        }

        li.doc-item {
            position: relative;
            margin-bottom: 4px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        li.doc-item:hover {
            background-color: #f0f0f0;
        }

        .doc-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            width: 100%;
        }

        .doc-checkbox {
            appearance: none;
            -webkit-appearance: none;
            min-width: 20px;
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            margin-right: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2px;
            background: #fff;
            cursor: pointer;
            flex-shrink: 0;
        }

        .doc-checkbox:checked::after {
            content: "X";
            font-weight: 900;
            color: #000;
            font-size: 16px;
            line-height: 1;
            font-family: Arial, sans-serif;
        }

        .doc-text {
            flex: 1;
            line-height: 1.4;
            word-break: break-word;
        }

        .doc-text a {
            color: #0056b3;
            font-weight: bold;
            text-decoration: underline;
        }

        .btn-remove {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            z-index: 10;
        }

        li.doc-item:hover .btn-remove {
            display: block;
        }

        .extra-docs {
            background: #fffbe6;
            padding: 15px;
            border: 1px solid #ffe58f;
            border-radius: 4px;
            margin-top: 20px;
        }

        .add-doc-row {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }

        .add-doc-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn-add-item {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0 15px;
            cursor: pointer;
            font-weight: bold;
        }

        footer {
            text-align: center;
            margin-top: auto;
            padding: 20px;
            font-size: 0.8rem;
        }

        .admin-link {
            color: #aaa;
            text-decoration: none;
        }

        #admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
        }

        .admin-content {
            background: white;
            margin: 30px auto;
            padding: 30px;
            width: 90%;
            max-width: 900px;
            border-radius: 12px;
            position: relative;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .item-list {
            border: 1px solid #eee;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .list-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #fff;
        }

        .btn-sm {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .btn-move {
            color: white;
            background: #ebe9e9;
            font-size: 0.8rem;
            padding: 5px 8px;
            min-width: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-move:disabled {
            background: #f9f9f9;
            color: #adb5bd;
            cursor: not-allowed;
            visibility: hidden;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-del {
            background: #dc3545;
            color: white;
        }

        .btn-add {
            background: #28a745;
            color: white;
        }

        .dropdown-container {
            position: relative;
            user-select: none;
        }

        .dropdown-trigger {
            background: #fff;
            border: 1px solid var(--border);
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 21px;
        }

        .dropdown-trigger::after {
            content: "";
            border: 5px solid transparent;
            border-top-color: #666;
            margin-left: 10px;
        }

        .dropdown-menu {
            position: absolute;
            top: 105%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            padding-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f0f7ff;
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .dropdown-ok {
            padding: 8px;
            border-top: 1px solid #eee;
            position: sticky;
            bottom: 0;
            background: white;
            text-align: center;
        }

        .dropdown-ok button {
            background: var(--success);
            color: white;
            border: none;
            padding: 6px 0;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .dropdown-ok button:hover {
            background: #218838;
        }
        
        /* Bulk Actions Styles */
        .bulk-actions {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .bulk-check {
            transform: scale(1.3);
            margin-right: 10px;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0056b3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media print {
            body {
                padding: 0;
                font-size: 12pt;
                background: white;
            }

            .container {
                box-shadow: none;
                padding: 0;
                max-width: 100%;
            }

            .toolbar,
            footer,
            #creation-screen,
            #loading-overlay,
            .add-doc-row {
                display: none !important;
            }

            #checklist-screen {
                display: block !important;
            }

            .btn-remove {
                display: none !important;
            }

            li.doc-item:hover {
                background-color: transparent;
            }

            .person-block {
                border-left-width: 2px;
            }

            .doc-checkbox {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border-color: #000 !important;
            }

            .doc-checkbox:checked::after {
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top:15px; font-weight:bold; color:#0056b3;">Carregando dados...</p>
    </div>
    <div class="container">
        <div id="creation-screen">
            <h1>Gerador de Checklist</h1>
            <div class="subtitle" id="gen-subtitle">Documentos para inscri√ß√£o no Cadastro √önico de Bolsas da UFG</div>
            <div class="alert" id="gen-alert-box">
                <h4 id="gen-alert-title">Aten√ß√£o</h4> 
                <span id="gen-alert-body">Este gerador de checklist visa facilitar a identifica√ß√£o dos documentos necess√°rios para inscri√ß√£o no Cadastro √önico de Bolsas da UFG, considerando a realidade socioecon√¥mica de cada estudante; entretanto, <strong>n√£o substitui a leitura cuidadosa da Rela√ß√£o de Documentos do edital.</strong></span>
            </div>
            <div class="info-text">
                <strong>Defini√ß√£o de Grupo Familiar:</strong> √© considerado grupo familiar todas as pessoas que moram com voc√™, que dividem ou n√£o a mesma renda, eventualmente ampliada por outras pessoas que contribuam para o rendimento ou tenham suas despesas atendidas por aquela unidade familiar, todas moradoras em um mesmo domic√≠lio.
            </div>
            <div class="info-text" style="margin-bottom:30px;">
                <strong>Importante:</strong> o/a estudante que se define como √∫nico membro do grupo familiar e n√£o possua rendimento pr√≥prio suficiente para a sua subsist√™ncia dever√° informar o grupo familiar de origem, ainda que residente em local diverso do seu domic√≠lio.
            </div>
            <div id="step-1">
                <label for="family-size">Quantidade de pessoas no grupo familiar (al√©m do estudante):</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="family-size" min="0" value="0">
                    <button class="btn-primary" style="width: auto; margin-top:0;" onclick="renderForm()">Iniciar</button>
                </div>
            </div>
            <div id="form-container"></div>
        </div>
        <div id="checklist-screen">
            <div class="toolbar">
                <button class="btn-tool btn-back" onclick="closeChecklist()">‚¨Ö Voltar / Novo</button>
                <button class="btn-tool btn-save" onclick="manualSave()">üíæ Salvar</button>
                <button class="btn-tool btn-link" onclick="copyLink()">üîó Copiar Link</button>
                <button class="btn-tool btn-print" onclick="printAndSaveToCloud()">üñ®Ô∏è Imprimir / PDF</button>
            </div>
            <h1 id="check-title" style="border-bottom: 2px solid #ddd; padding-bottom: 10px;">Checklist de Documentos - Cadastro √önico UFG</h1>
            <div class="alert" id="check-alert-box">
                <h4 id="check-instr-title">Instru√ß√µes:</h4>
                <span id="check-instr-body">
                <strong>a)</strong> N√£o √© necess√°rio que as declara√ß√µes estejam autenticadas, mas √© preciso que o declarante assine como no RG, que deve acompanhar as declara√ß√µes;</br>
                <strong>b)</strong> No caso de extratos banc√°rios emitidos via Internet que n√£o contenham o nome do titular da conta, o estudante dever√° identificar;</br>
                <strong>c)</strong> Em casos extremos, em que n√£o seja poss√≠vel apresentar um determinado documento, poder√° ser apresentada uma declara√ß√£o de aus√™ncia, devidamente justificada e comprovada.
                </span>
            </div>
            <div id="checklist-content" class="checklist-content"></div>
        </div>
    </div>
    <footer>
        <div id="status-bar" style="margin-bottom:10px; font-size:0.8rem; color:#666;"></div>
        <a href="#" class="admin-link" onclick="openAdmin()">√Årea Administrativa</a>
    </footer>
    <div id="admin-modal">
        <div class="admin-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:var(--primary);">Painel Administrativo</h2>
                <button class="btn-sm" onclick="closeAdmin()" style="background:#666; color:white;">Fechar</button>
            </div>
            <div id="login-screen">
                <label>Senha de Acesso:</label>
                <div style="display:flex; gap:10px;">
                    <input type="password" id="admin-pass" placeholder="Sua senha de admin">
                    <button class="btn-sm btn-primary" style="margin:0; width:auto;" onclick="checkLogin()">Entrar</button>
                </div>
                <p style="font-size:0.8rem; color:#666; margin-top:10px;">Acesso √† √°rea de administra√ß√£o</p>
            </div>
            <div id="admin-panel" style="display:none;">
                <div class="admin-tabs">
                    <button class="tab-btn active" onclick="switchTab('saved')">Listas Geradas</button>
                    <button class="tab-btn" onclick="switchTab('texts')">Textos do Site</button>
                    <button class="tab-btn" onclick="switchTab('situations')">Situa√ß√µes</button>
                    <button class="tab-btn" onclick="switchTab('questions')">Perguntas</button>
                    <button class="tab-btn" onclick="switchTab('basics')">Docs Gerais</button>
                </div>
                <div id="tab-saved">
                    <div class="bulk-actions">
                        <label style="font-size:0.9rem; margin:0;"><input type="checkbox" id="check-all" onchange="toggleAllSaved(this)"> Tudo</label>
                        <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
                        <button class="btn-sm btn-del" onclick="deleteSelected()">Excluir Selecionados</button>
                        <div style="flex:1"></div>
                        <span style="font-size:0.85rem;">Excluir anteriores a:</span>
                        <input type="date" id="date-limit" style="width:auto; padding:5px;">
                        <button class="btn-sm btn-del" onclick="deleteOlderThan()">Excluir</button>
                    </div>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <input type="text" id="search-candidate" placeholder="üîç Buscar nome (Deixe vazio para ver recentes)..." onkeypress="if(event.key==='Enter') searchServer()" style="flex:1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <button class="btn-sm btn-primary2" onclick="searchServer()" style="margin:0;">Buscar</button>
                    </div>
                    <div class="item-list" id="saved-list"></div>
                    <p style="font-size:0.8rem; color:#666; text-align:center; margin-top:5px;"> Mostrando apenas os 10 primeiros resultados da busca. </p>
                </div>
                <div id="tab-texts" style="display:none; padding-top:10px;">
                    <h3>Editar Textos do Site</h3>
                    <p style="font-size:0.85rem; color:#666;">Essas altera√ß√µes s√£o aplicadas imediatamente para todos os usu√°rios.</p>
                    
                    <label style="margin-top:15px;">T√≠tulo da Aba/Navegador:</label>
                    <input type="text" id="txt-page-title">
                    
                    <label style="margin-top:15px;">Subt√≠tulo (Tela Inicial):</label>
                    <input type="text" id="txt-subtitle">
                    
                    <label style="margin-top:15px;">T√≠tulo do Checklist (Impresso):</label>
                    <input type="text" id="txt-check-title">
                    
                    <div style="border-top:1px dashed #ccc; margin: 15px 0;"></div>
                    
                    <label>T√≠tulo do Aviso (Tela Inicial):</label>
                    <input type="text" id="txt-alert-title">
                    <label style="margin-top:5px;">Texto do Aviso (HTML permitido):</label>
                    <textarea id="txt-alert-body" style="height:80px;"></textarea>
                    
                    <div style="border-top:1px dashed #ccc; margin: 15px 0;"></div>

                    <label>T√≠tulo das Instru√ß√µes (Tela Checklist):</label>
                    <input type="text" id="txt-instr-title">
                    <label style="margin-top:5px;">Texto das Instru√ß√µes (HTML permitido):</label>
                    <textarea id="txt-instr-body" style="height:100px;"></textarea>

                    <button class="btn-primary" onclick="saveSiteTexts()">Salvar Textos</button>
                </div>
                <div id="tab-situations" style="display:none;">
                    <button class="btn-sm btn-add" onclick="editSituation(-1)">+ Nova Situa√ß√£o</button>
                    <div class="item-list" id="situations-list" style="margin-top:10px;"></div>
                </div>
                <div id="tab-questions" style="display:none;">
                    <button class="btn-sm btn-add" onclick="editQuestion(-1)">+ Nova Pergunta</button>
                    <div class="item-list" id="questions-list" style="margin-top:10px;"></div>
                </div>
                <div id="tab-basics" style="display:none; padding-top:10px;">
                    <h3>Editar Documentos Gerais</h3>
                    <p style="font-size:0.85rem; color:#666;">Estes documentos aparecer√£o automaticamente para todas as pessoas.</p>
                    <label style="margin-top:15px;">Para o Estudante (um por linha):</label>
                    <textarea id="basic-student-text" style="width:100%; min-height:120px; font-family:monospace; padding:10px;"></textarea>
                    <label style="margin-top:15px;">Para Familiares (um por linha):</label>
                    <textarea id="basic-family-text" style="width:100%; min-height:120px; font-family:monospace; padding:10px;"></textarea>
                    <button class="btn-primary" onclick="saveBasicDocs()">Salvar Altera√ß√µes</button>
                </div>
                <div id="edit-overlay" style="display:none; margin-top:20px; padding-top:20px; border-top:2px dashed #ccc;">
                    <h3 id="edit-title">Editar</h3>
                    <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
                    <label>T√≠tulo:</label><input type="text" id="edit-label">
                    <div id="situation-fields" style="display:none;">
                        <label>Documentos:</label>
                        <p style="font-size:0.8em; color:#666; margin:0 0 5px 0;">Para incluir link, use: <b>[Texto do Link](http://site.com)</b></p>
                        <textarea id="sit-docs" style="width:100%; min-height:150px;"></textarea>
                    </div>
                    <div id="question-fields" style="display:none;"><label>Op√ß√µes:</label>
                        <div id="options-container"></div><button class="btn-sm btn-add" onclick="addOptionRow()">+ Op√ß√£o</button>
                    </div>
                    <div style="margin-top:15px; display:flex; gap:10px;"><button class="btn-primary" onclick="saveEdit()">Salvar</button><button class="btn-sm" style="background:#999; color:white; margin-top: 20px;" onclick="cancelEdit()">Cancelar</button></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCSJRdWEr-IbY9hxn7LBj7nuY6M5bZ8HAE",
            authDomain: "checklist-b477f.firebaseapp.com",
            databaseURL: "https://checklist-b477f-default-rtdb.firebaseio.com",
            projectId: "checklist-b477f",
            storageBucket: "checklist-b477f.firebasestorage.app",
            messagingSenderId: "1069790989135",
            appId: "1:1069790989135:web:fc9469e63477bc45ba133a"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const CloudManager = (function() {
            const db = firebase.database();
            const auth = firebase.auth();
            let currentUser = null;

            function init() {
                auth.onAuthStateChanged(user => {
                    currentUser = user;
                    if (user) {
                        syncData();
                    } else {
                        auth.signInAnonymously().catch(console.error);
                    }
                });
            }
            async function loginAdmin(email, password) {
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    return true;
                } catch (e) {
                    alert("Erro de login: " + e.message);
                    return false;
                }
            }
            async function fetchSettings() {
                const snap = await db.ref('checklist_app/settings').once('value');
                return snap.val();
            }
            async function fetchSpecificChecklist(id) {
                const snap = await db.ref(`checklist_app/savedLists/${id}`).once('value');
                return snap.val();
            }
            async function fetchListsForAdmin(searchTerm = "") {
                if (!currentUser || !currentUser.email) return [];
                let query;
                const ref = db.ref('checklist_app/savedLists');
                if (searchTerm) {
                    query = ref.orderByChild('name').startAt(searchTerm).endAt(searchTerm + "\uf8ff").limitToFirst(10);
                } else {
                    query = ref.orderByKey().limitToLast(10);
                }
                const snap = await query.once('value');
                const val = snap.val();
                if (!val) return [];
                let list = Object.keys(val).map(key => val[key]);
                if (!searchTerm) list.reverse();
                return list;
            }
            async function saveSettings(data) {
                if (!currentUser || !currentUser.email) throw new Error("Acesso negado.");
                await db.ref('checklist_app/settings').set(data);
            }
            async function saveSingleChecklist(checklistData) {
                await db.ref(`checklist_app/savedLists/${checklistData.id}`).set(checklistData);
            }
            async function deleteChecklist(id) {
                if (!currentUser || !currentUser.email) throw new Error("Acesso negado.");
                await db.ref(`checklist_app/savedLists/${id}`).remove();
            }
            return {
                init,
                loginAdmin,
                fetchSettings,
                fetchSpecificChecklist,
                fetchListsForAdmin,
                saveSettings,
                saveSingleChecklist,
                deleteChecklist,
                getUser: () => currentUser
            };
        })();
        CloudManager.init();
        
        // --- DATA STRUCTURE UPDATE ---
        const defaultData = {
            basicDocsStudent: ['RG e CPF'],
            basicDocsFamily: ['RG e CPF'],
            situations: [],
            questions: [],
            // Novos campos para textos din√¢micos
            siteTexts: {
                pageTitle: "Checklist de Documentos - Cadastro √önico UFG",
                subtitle: "Documentos para inscri√ß√£o no Cadastro √önico de Bolsas da UFG",
                checkTitle: "Checklist de Documentos - Cadastro √önico UFG",
                alertTitle: "Aten√ß√£o",
                alertBody: "Este gerador de checklist visa facilitar a identifica√ß√£o dos documentos necess√°rios para inscri√ß√£o no Cadastro √önico de Bolsas da UFG, considerando a realidade socioecon√¥mica de cada estudante; entretanto, <strong>n√£o substitui a leitura cuidadosa da Rela√ß√£o de Documentos do edital.</strong>",
                instrTitle: "Instru√ß√µes:",
                instrBody: "<strong>a)</strong> N√£o √© necess√°rio que as declara√ß√µes estejam autenticadas, mas √© preciso que o declarante assine como no RG, que deve acompanhar as declara√ß√µes;</br><strong>b)</strong> No caso de extratos banc√°rios emitidos via Internet que n√£o contenham o nome do titular da conta, o estudante dever√° identificar;</br><strong>c)</strong> Em casos extremos, em que n√£o seja poss√≠vel apresentar um determinado documento, poder√° ser apresentada uma declara√ß√£o de aus√™ncia, devidamente justificada e comprovada."
            }
        };
        let appData = defaultData;
        let savedLists = [];
        let currentChecklistId = null;
        let isDirty = false;
        window.addEventListener('beforeunload', (e) => {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = 'Altera√ß√µes n√£o salvas.';
            }
        });

        function showLoading(msg) {
            document.getElementById('loading-text').textContent = msg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function aplicarRegras(pIdx) {
            if (!appData.questions) return;
            // Varre todas as perguntas do card dessa pessoa (pIdx)
            appData.questions.forEach((q, targetIndex) => {
                // Gera o ID √∫nico do box desta pessoa e desta pergunta
                const boxId = `q-box-${pIdx}-${targetIndex}`;
                const box = document.getElementById(boxId);
                if (!box) return;
                if (q.dependsOn) {
                    const parts = q.dependsOn.split(':').map(s => s.trim());
                    if (parts.length < 2) return;
                    const parentId = parts[0];
                    const requiredOptIndex = parts[1];
                    const parentIndex = appData.questions.findIndex(x => x.id === parentId);
                    if (parentIndex === -1) {
                        console.warn(`ID n√£o encontrado: ${parentId}`);
                        return;
                    }
                    // Pega o select da pergunta PAI dentro do card da MESMA PESSOA (pIdx)
                    const parentSelectId = `extra-${pIdx}-${parentIndex}`;
                    const parentSelect = document.getElementById(parentSelectId);
                    const selectTargetId = `extra-${pIdx}-${targetIndex}`;
                    const selectTarget = document.getElementById(selectTargetId);
                    const selectedValue = parentSelect ? parentSelect.value : '';
                    // Verifica se a op√ß√£o bate (Ex: valor "0-1" -> split d√° "1")
                    if (selectedValue && selectedValue.split('-')[1] === requiredOptIndex) {
                        box.style.display = 'block';
                    } else {
                        box.style.display = 'none';
                        if (selectTarget) selectTarget.value = "";
                    }
                }
            });
        }

        function renderForm() {
            const c = document.getElementById('form-container');
            const s = parseInt(document.getElementById('family-size').value);
            if (isNaN(s) || s < 0) return alert('Inv√°lido');
            c.innerHTML = '';
            // Cria estudante e aplica regras
            c.appendChild(createMemberCard('Estudante', 0, true));
            setTimeout(() => aplicarRegras(0), 100);
            // Cria familiares e aplica regras
            for (let i = 1; i <= s; i++) {
                c.appendChild(createMemberCard(`${i}¬∫ Membro do grupo familiar`, i, false));
                setTimeout(() => aplicarRegras(i), 100);
            }
            const b = document.createElement('button');
            b.className = 'btn-primary';
            b.textContent = 'Gerar Checklist';
            b.onclick = generateChecklist;
            c.appendChild(b);
        }

        function createMemberCard(title, i, isCand) {
            const card = document.createElement('div');
            card.style.cssText = 'background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:20px; margin-top:20px;';
            let h = `<div class="section-header" style="margin-top:0;">${title}</div>
             <div style="margin-bottom:15px;"><label>Nome:</label><input type="text" id="name-${i}"></div>
             <div style="margin-bottom:15px;"><label>Situa√ß√£o:</label><div id="sit-wrapper-${i}"></div></div>`;
            if (isCand && appData.questions) {
                h += `<div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;"><h4 style="color:#666;">Informa√ß√µes complementares</h4>`;
                appData.questions.forEach((q, qi) => {
                    let o = `<option value="">Escolha...</option>`;
                    q.options.forEach((opt, oi) => o += `<option value="${qi}-${oi}">${opt.label}</option>`);
                    const boxId = `q-box-${i}-${qi}`;
                    const selectId = `extra-${i}-${qi}`;
                    const style = q.dependsOn ? 'display:none;' : 'display:block;';
                    h += `<div id="${boxId}" style="margin-bottom:15px; ${style}">
                    <label>${q.text}</label>
                    <select id="${selectId}" onchange="aplicarRegras(${i})">${o}</select>
                  </div>`;
                });
                h += '</div>';
            }
            card.innerHTML = h;
            card.querySelector(`#sit-wrapper-${i}`).appendChild(createMultiSelect(`multi-${i}`, appData.situations));
            return card;
        }

        function createMultiSelect(id, items) {
            const c = document.createElement('div');
            c.className = 'dropdown-container';
            c.id = `container-${id}`;
            const t = document.createElement('div');
            t.className = 'dropdown-trigger';
            t.innerHTML = '<span class="trigger-text">Selecione...</span>';
            t.onclick = (e) => {
                e.stopPropagation();
                toggleDropdown(id);
            };
            const m = document.createElement('div');
            m.className = 'dropdown-menu';
            m.id = `menu-${id}`;
            items.forEach(i => {
                const r = document.createElement('label');
                r.className = 'dropdown-item';
                r.innerHTML = `<input type="checkbox" value="${i.id}" onchange="updateTrigger('${id}')">${i.label}`;
                r.onclick = (e) => e.stopPropagation();
                m.appendChild(r);
            });
            const ok = document.createElement('div');
            ok.className = 'dropdown-ok';
            ok.innerHTML = '<button type="button">OK</button>';
            ok.onclick = (e) => {
                e.stopPropagation();
                toggleDropdown(id);
            };
            m.appendChild(ok);
            c.appendChild(t);
            c.appendChild(m);
            return c;
        }

        function toggleDropdown(id) {
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m.id !== `menu-${id}`) m.classList.remove('show');
            });
            document.getElementById(`menu-${id}`).classList.toggle('show');
        }

        function updateTrigger(id) {
            const c = document.getElementById(`container-${id}`);
            const ch = c.querySelectorAll('input:checked');
            const s = c.querySelector('.trigger-text');
            s.textContent = !ch.length ? 'Selecione...' : Array.from(ch).map(x => x.parentNode.textContent.trim()).join(', ');
            s.style.color = !ch.length ? '#666' : '#000';
        }
        document.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show')));

        function markDirty() {
            isDirty = true;
        }

        function removeDoc(btn) {
            btn.parentElement.remove();
            markDirty();
        }

        function formatDocText(text) {
            return text.replace(/^[\(\s\)]+/, '').trim().replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        }

        function addNewDoc(btn) {
            const input = btn.previousElementSibling;
            const text = input.value.trim();
            if (!text) return;

            // 1. Identifica a linha onde est√° o bot√£o e o pai (bloco da pessoa)
            const row = btn.closest('.add-doc-row');
            const prev = row.previousElementSibling;
            let targetUl = null;

            // 2. L√≥gica inteligente para achar a lista correta:
            
            // Caso A: O elemento imediatamente acima √© uma lista (Situa√ß√£o normal)
            if (prev && prev.tagName === 'UL') {
                targetUl = prev;
            }
            // Caso B: O elemento acima √© um bloco (ex: Complementares ou div de pergunta), buscamos a lista DENTRO dele
            else if (prev && prev.tagName === 'DIV') {
                const listsInside = prev.querySelectorAll('ul');
                if (listsInside.length > 0) {
                    // Pega a √∫ltima lista dentro desse bloco
                    targetUl = listsInside[listsInside.length - 1];
                }
            }

            // Caso C (Seguran√ßa): Se n√£o achou nada acima, pega a √∫ltima lista dispon√≠vel no cart√£o da pessoa
            if (!targetUl) {
                const parent = row.parentElement;
                const allLists = parent.querySelectorAll('ul');
                if (allLists.length > 0) targetUl = allLists[allLists.length - 1];
            }

            // Caso D: Se n√£o existir nenhuma lista no cart√£o, cria uma nova
            if (!targetUl) {
                targetUl = document.createElement('ul');
                row.parentElement.insertBefore(targetUl, row);
            }

            // 3. Insere o item na lista encontrada (Agora herda o estilo correto sem marcadores)
            targetUl.insertAdjacentHTML('beforeend', `<li class="doc-item"><label class="doc-label"><input type="checkbox" class="doc-checkbox" onchange="markDirty()"><span class="doc-text">${formatDocText(text)}</span></label><button class="btn-remove" onclick="removeDoc(this)">X</button></li>`);
            
            input.value = ''; 
            markDirty();
        }

        function addNewObs(btn) {
            const input = btn.previousElementSibling;
            const text = input.value.trim();
            if (!text) return;
            const ul = btn.closest('div').previousElementSibling;
            ul.insertAdjacentHTML('beforeend', `<li class="doc-item"><div style="padding:5px 30px 5px 5px;"><span class="doc-text" style="display:block;">${formatDocText(text)}</span></div><button class="btn-remove" onclick="removeDoc(this)">X</button></li>`);
            input.value = '';
            markDirty();
        }

        function generateChecklist() {
            const size = parseInt(document.getElementById('family-size').value);
            
            // --- BLOCO DE VALIDA√á√ÉO ---
            // Verifica todos os campos antes de gerar
            for (let i = 0; i <= size; i++) {
                const memberName = i === 0 ? 'do Estudante' : `do ${i}¬∫ Familiar`;

                // 1. Valida Nome (Obrigat√≥rio)
                const nameInput = document.getElementById(`name-${i}`);
                if (!nameInput.value.trim()) {
                    alert(`Por favor, preencha o nome ${memberName}.`);
                    nameInput.focus();
                    return; 
                }

                // 2. Valida Situa√ß√£o (Obrigat√≥rio - pelo menos 1 selecionado)
                const situationsChecked = document.querySelectorAll(`#container-multi-${i} input:checked`);
                if (situationsChecked.length === 0) {
                    alert(`Por favor, selecione a Situa√ß√£o (Renda) ${memberName}.`);
                    
                    // D√° um destaque visual no campo com erro
                    const container = document.getElementById(`container-multi-${i}`);
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const trigger = container.querySelector('.dropdown-trigger');
                    trigger.style.borderColor = "red";
                    trigger.style.boxShadow = "0 0 5px rgba(255,0,0,0.3)";
                    
                    // Remove o destaque ap√≥s 3 segundos
                    setTimeout(() => {
                        trigger.style.borderColor = "#e0e0e0";
                        trigger.style.boxShadow = "none";
                    }, 3000);
                    
                    return;
                }

                // 3. Valida Perguntas (Apenas para o estudante - √≠ndice 0)
                if (i === 0 && appData.questions) {
                    for (let qi = 0; qi < appData.questions.length; qi++) {
                        // Verifica se a pergunta existe no DOM
                        const boxId = `q-box-${i}-${qi}`;
                        const selectId = `extra-${i}-${qi}`;
                        const box = document.getElementById(boxId);
                        const select = document.getElementById(selectId);
                        
                        // S√≥ valida se a pergunta estiver vis√≠vel E n√£o tiver resposta
                        if (box && select && box.style.display !== 'none' && !select.value) {
                            alert(`Campo obrigat√≥rio: Por favor, responda a pergunta "${appData.questions[qi].text}"`);
                            select.focus();
                            select.style.borderColor = "red";
                             setTimeout(() => { select.style.borderColor = "#e0e0e0"; }, 3000);
                            return;
                        }
                    }
                }
            }
            // --- FIM DA VALIDA√á√ÉO ---

            const item = t => `<li class="doc-item"><label class="doc-label"><input type="checkbox" class="doc-checkbox" onchange="markDirty()"><span class="doc-text">${formatDocText(t)}</span></label><button class="btn-remove" onclick="removeDoc(this)">X</button></li>`;
            const addBox = `<div class="add-doc-row"><input class="add-doc-input" placeholder="Adicionar documento"><button class="btn-add-item" onclick="addNewDoc(this)">+</button></div>`;
            let html = '',
                cName = '';
            
            for (let i = 0; i <= size; i++) {
                const n = document.getElementById(`name-${i}`).value.trim();
                
                if (i === 0) cName = n;
                const ch = document.querySelectorAll(`#container-multi-${i} input:checked`);
                const basicList = (i === 0) ? (appData.basicDocsStudent || []) : (appData.basicDocsFamily || []);
                let basicHtml = '';
                basicList.forEach(t => basicHtml += item(t));
                html += `<div class="person-block"><h3>${i===0?'Estudante':'Familiar'}: ${n}</h3><strong>Gerais:</strong><ul>${basicHtml}</ul>`;
                
                // Como agora √© obrigat√≥rio, sempre haver√° itens aqui
                if (ch.length) {
                    html += '<strong>Rendimentos:</strong><ul>';
                    let d = [];
                    ch.forEach(c => {
                        const s = appData.situations.find(x => x.id === c.value);
                        if (s) d.push(...s.docs);
                    });
                    [...new Set(d)].forEach(x => html += item(x));
                    html += '</ul>';
                }
                
                // Processamento das perguntas
                if(i === 0 && appData.questions) {
                    let extraDocsHtml = '';
                    appData.questions.forEach((q, qi) => {
                        const box = document.getElementById(`q-box-${i}-${qi}`);
                        if (box && box.style.display === 'none') return;

                        const v = document.getElementById(`extra-${i}-${qi}`).value;
                        if (v) {
                            const [x, y] = v.split('-');
                            const op = appData.questions[x].options[y];
                            if (op.docs && op.docs.length) {
                                extraDocsHtml += op.docs.map(d => item(d)).join('');
                            }
                        }
                    });

                    if(extraDocsHtml) {
                        html += `<div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:5px;">
                                   <strong>Complementares:</strong>
                                   <ul>${extraDocsHtml}</ul>
                                 </div>`;
                    }
                }
                html += addBox + '</div>';
            }
            html += `<div class="person-block" style="border-left-color:#666; margin-top:20px;"><h3>Observa√ß√µes</h3><ul></ul><div class="add-doc-row"><input class="add-doc-input" placeholder="+ Obs"><button class="btn-add-item" onclick="addNewObs(this)">+</button></div></div>`;
            const content = document.getElementById('checklist-content');
            content.innerHTML = html;
            content.dataset.candidate = cName;
            currentChecklistId = null;
            updateUrl(null);
            isDirty = true;
            document.getElementById('creation-screen').style.display = 'none';
            document.getElementById('checklist-screen').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function closeChecklist() {
            if (isDirty && !confirm("Deseja realmente voltar?")) return;
            document.getElementById('checklist-screen').style.display = 'none';
            document.getElementById('creation-screen').style.display = 'block';
            currentChecklistId = null;
            isDirty = false;
            updateUrl(null);
        }

        function updateUrl(id) {
            const url = new URL(window.location);
            if (id) url.searchParams.set('id', id);
            else url.searchParams.delete('id');
            window.history.pushState({}, '', url);
        }
        async function saveLogic(silent = false) {
            const div = document.getElementById('checklist-content');
            const name = div.dataset.candidate || 'Sem Nome';
            div.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked ? c.setAttribute('checked', 'checked') : c.removeAttribute('checked'));
            const html = div.innerHTML;
            let newItem = {
                id: currentChecklistId || Date.now(),
                name,
                html,
                created: new Date().toLocaleString()
            };
            if (!currentChecklistId) {
                currentChecklistId = newItem.id;
                updateUrl(newItem.id);
            }
            const success = await saveDataToCloud(newItem);
            if (success) {
                isDirty = false;
                if (!silent) alert("Salvo com sucesso!");
            }
            return success;
        }
        async function manualSave() {
            await saveLogic(false);
        }
        async function printAndSaveToCloud() {
            await saveLogic(true);
            setTimeout(() => window.print(), 200);
        }
        async function loadChecklist(id) {
            if (isDirty && !confirm("Altera√ß√µes perdidas. Continuar?")) return;
            showLoading('Carregando...');
            const l = await CloudManager.fetchSpecificChecklist(id);
            hideLoading();
            if (!l) {
                alert('N√£o encontrado.');
                updateUrl(null);
                return;
            }
            const c = document.getElementById('checklist-content');
            c.innerHTML = l.html;
            c.dataset.candidate = l.name;
            currentChecklistId = l.id;
            isDirty = false;
            updateUrl(l.id);
            closeAdmin();
            document.getElementById('creation-screen').style.display = 'none';
            document.getElementById('checklist-screen').style.display = 'block';
        }

        async function copyLink() {
            // 1. Primeiro salva os dados (modo silencioso = true) para garantir que tenha um ID na URL
            const saved = await saveLogic(true);
            
            // 2. Se salvou com sucesso, copia o link atualizado
            if (saved) {
                navigator.clipboard.writeText(window.location.href).then(() => alert("Link salvo e copiado com sucesso! üîó"));
            }
        }
        
        async function deleteSavedList(id) {
            if (!confirm('Excluir?')) return;
            await CloudManager.deleteChecklist(id);
            searchServer();
        }
        
        // --- RENDER SITE TEXTS FUNCTION ---
        function renderSiteTexts() {
            const t = appData.siteTexts || defaultData.siteTexts;
            if(t.pageTitle) document.getElementById('page-title-tag').textContent = t.pageTitle;
            if(t.subtitle) document.getElementById('gen-subtitle').textContent = t.subtitle;
            if(t.checkTitle) document.getElementById('check-title').textContent = t.checkTitle;
            if(t.alertTitle) document.getElementById('gen-alert-title').textContent = t.alertTitle;
            if(t.alertBody) document.getElementById('gen-alert-body').innerHTML = t.alertBody;
            if(t.instrTitle) document.getElementById('check-instr-title').textContent = t.instrTitle;
            if(t.instrBody) document.getElementById('check-instr-body').innerHTML = t.instrBody;
        }

        async function syncData() {
            showLoading('Iniciando...');
            try {
                const settings = await CloudManager.fetchSettings();
                if (settings) appData = settings;
                
                // Se n√£o tiver textos definidos (primeira vez), usar default
                if(!appData.siteTexts) appData.siteTexts = defaultData.siteTexts;
                
                renderSiteTexts(); // Aplicar textos
                
                const user = CloudManager.getUser();
                if (user && user.email) {
                    savedLists = await CloudManager.fetchListsForAdmin();
                }
                document.getElementById('status-bar').textContent = "";
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id) loadChecklist(parseInt(id));
            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }
        async function saveDataToCloud(arg) {
            showLoading('Salvando...');
            try {
                if (arg === true) await CloudManager.saveSettings(appData);
                else await CloudManager.saveSingleChecklist(arg);
                document.getElementById('status-bar').textContent = "‚úÖ Salvo!";
                return true;
            } catch (e) {
                alert("Erro: " + e.message);
                return false;
            } finally {
                hideLoading();
            }
        }
        window.onload = function() {
            showLoading('Conectando...');
        };

        function openAdmin() {
            document.getElementById('admin-modal').style.display = 'block';
        }

        function closeAdmin() {
            document.getElementById('admin-modal').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
        }
        async function checkLogin() {
            const pass = document.getElementById('admin-pass').value;
            const adminEmail = "wenea.br@gmail.com";
            showLoading("Verificando...");
            const success = await CloudManager.loginAdmin(adminEmail, pass);
            if (success) {
                await searchServer();
                hideLoading();
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                renderAdminLists();
                // Preencher campos de textos
                const t = appData.siteTexts || defaultData.siteTexts;
                document.getElementById('txt-page-title').value = t.pageTitle || "";
                document.getElementById('txt-subtitle').value = t.subtitle || "";
                document.getElementById('txt-check-title').value = t.checkTitle || "";
                document.getElementById('txt-alert-title').value = t.alertTitle || "";
                document.getElementById('txt-alert-body').value = t.alertBody || "";
                document.getElementById('txt-instr-title').value = t.instrTitle || "";
                document.getElementById('txt-instr-body').value = t.instrBody || "";
            } else {
                hideLoading();
            }
        }
        async function searchServer() {
            const term = document.getElementById('search-candidate').value.trim();
            showLoading('Buscando...');
            savedLists = await CloudManager.fetchListsForAdmin(term);
            hideLoading();
            renderSavedList();
            if (savedLists.length === 0) document.getElementById('saved-list').innerHTML = '<p style="padding:10px;text-align:center">Vazio.</p>';
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['saved', 'texts', 'situations', 'questions', 'basics'].forEach(x => document.getElementById(`tab-${x}`).style.display = 'none');
            document.getElementById(`tab-${t}`).style.display = 'block';
            if (t === 'basics') {
                document.getElementById('basic-student-text').value = (appData.basicDocsStudent || []).join('\n');
                document.getElementById('basic-family-text').value = (appData.basicDocsFamily || []).join('\n');
            }
        }
        
        async function saveSiteTexts() {
             appData.siteTexts = {
                pageTitle: document.getElementById('txt-page-title').value,
                subtitle: document.getElementById('txt-subtitle').value,
                checkTitle: document.getElementById('txt-check-title').value,
                alertTitle: document.getElementById('txt-alert-title').value,
                alertBody: document.getElementById('txt-alert-body').value,
                instrTitle: document.getElementById('txt-instr-title').value,
                instrBody: document.getElementById('txt-instr-body').value
            };
            if (await saveDataToCloud(true)) {
                alert("Textos atualizados! A p√°gina ser√° recarregada para aplicar.");
                location.reload();
            }
        }

        async function saveBasicDocs() {
            appData.basicDocsStudent = document.getElementById('basic-student-text').value.split('\n').filter(x => x.trim());
            appData.basicDocsFamily = document.getElementById('basic-family-text').value.split('\n').filter(x => x.trim());
            if (await saveDataToCloud(true)) alert("Atualizado!");
        }

        function renderSavedList() {
            const el = document.getElementById('saved-list');
            el.innerHTML = savedLists.length ? savedLists.map(i => `
        <div class="list-row">
            <div style="display:flex; align-items:center;">
                <input type="checkbox" class="bulk-check" value="${i.id}">
                <div style="margin-left:10px;">
                    <strong>${i.name}</strong><br><small>${i.updated || i.created || '---'}</small>
                </div>
            </div>
            <div>
                <button class="btn-sm btn-edit" onclick="loadChecklist(${i.id})">Abrir</button>
                <button class="btn-sm btn-del" onclick="deleteSavedList(${i.id})">X</button>
            </div>
        </div>
    `).join('') : '<p style="padding:10px">Vazio</p>';
        }
        
        function toggleAllSaved(source) {
            document.querySelectorAll('.bulk-check').forEach(c => c.checked = source.checked);
        }
        
        async function deleteSelected() {
            const checked = Array.from(document.querySelectorAll('.bulk-check:checked')).map(c => c.value);
            if(checked.length === 0) return alert("Selecione itens para excluir.");
            if(!confirm(`Excluir ${checked.length} itens? Esta a√ß√£o √© irrevers√≠vel.`)) return;
            
            showLoading("Excluindo em massa...");
            for (let id of checked) {
                try { await CloudManager.deleteChecklist(id); } catch(e) { console.error(e); }
            }
            await searchServer(); // Recarrega
            hideLoading();
        }
        
        async function deleteOlderThan() {
            const dateStr = document.getElementById('date-limit').value;
            if(!dateStr) return alert("Escolha uma data.");
            
            // Converte a data escolhida para timestamp (final do dia ou inicio do dia seguinte para garantir seguran√ßa)
            // Aqui vamos assumir 00:00 do dia SEGUINTE para apagar tudo DO dia selecionado para tr√°s, ou 00:00 do dia mesmo.
            // O padr√£o ID √© Date.now(). Vamos pegar a data escolhida + 1 dia 00:00 para garantir
            const limitDate = new Date(dateStr);
            // Ajuste de fuso hor√°rio simples para garantir compara√ß√£o correta com UTC/Local
            const limitTimestamp = limitDate.getTime() + (24 * 60 * 60 * 1000); // Fim do dia selecionado aprox
            
            if(!confirm(`Tem certeza que deseja EXCLUIR TODOS os checklists criados ANTES de ${dateStr}?`)) return;
            
            // Busca TODOS (limitado a um n√∫mero grande ou precisa de pagina√ß√£o, mas vamos usar a lista atual carregada)
            // Como a lista atual √© paginada (10), precisamos buscar mais ou iterar no servidor.
            // Limitation: O CloudManager atual busca s√≥ 10. Para bulk delete real por data, idealmente far√≠amos no backend.
            // Workaround: Vamos varrer o que o Firebase permitir buscar.
            
            showLoading("Buscando e excluindo...");
            
            // Pega lista completa (cuidado com performance se tiver milhares)
            const ref = firebase.database().ref('checklist_app/savedLists');
            const snap = await ref.orderByKey().endAt(limitTimestamp.toString()).once('value');
            
            const toDelete = snap.val();
            if(!toDelete) {
                hideLoading();
                return alert("Nada encontrado anterior a essa data.");
            }
            
            const keys = Object.keys(toDelete);
            if(!confirm(`Encontrados ${keys.length} registros antigos. Confirmar exclus√£o total?`)) {
                hideLoading();
                return;
            }
            
            for(let key of keys) {
                 await CloudManager.deleteChecklist(key);
            }
            
            await searchServer();
            hideLoading();
            alert("Limpeza conclu√≠da.");
        }

        function renderAdminLists() {
            const moveBtns = (type, i, len) => `
        <div style="display:inline-flex;gap:2px;margin-right:5px;">
            <button type="button" class="btn-sm btn-move" onclick="moveItem('${type}',${i},-1)" ${i===0?'disabled':''}>‚¨ÜÔ∏è</button>
            <button type="button" class="btn-sm btn-move" onclick="moveItem('${type}',${i},1)" ${i===len-1?'disabled':''}>‚¨áÔ∏è</button>
        </div>`;
            document.getElementById('situations-list').innerHTML = appData.situations.map((s, i) => `<div class="list-row"><div style="flex:1"><strong>${s.label}</strong></div>
        <div style="display:flex;">${moveBtns('situation',i,appData.situations.length)}
        <button type="button" class="btn-sm btn-edit" onclick="editSituation(${i})">Editar</button>
        <button type="button" class="btn-sm btn-del" onclick="delItem('situation',${i})">X</button></div></div>`).join('');
            document.getElementById('questions-list').innerHTML = appData.questions.map((q, i) => `<div class="list-row"><div style="flex:1"><strong>${q.text}</strong><br><small style="color:#6f42c1;font-family:monospace">ID: ${q.id}</small>${q.dependsOn?`<br><small style="color:#e67e22">‚Ü≥ Dep: ${q.dependsOn}</small>`:''}</div>
        <div style="display:flex;">${moveBtns('question',i,appData.questions.length)}
        <button type="button" class="btn-sm btn-edit" onclick="editQuestion(${i})">Editar</button>
        <button type="button" class="btn-sm btn-del" onclick="delItem('question',${i})">X</button></div></div>`).join('');
        }

        function setupEdit(type, id) {
            document.getElementById('edit-overlay').style.display = 'block';
            document.getElementById('edit-type').value = type;
            document.getElementById('edit-id').value = id;
            document.getElementById('situation-fields').style.display = type === 'situation' ? 'block' : 'none';
            document.getElementById('question-fields').style.display = type === 'question' ? 'block' : 'none';
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('edit-label').value = '';
            document.getElementById('sit-docs').value = '';
            if (document.getElementById('dep-field')) document.getElementById('dep-field').remove();
            if (type === 'question') {
                const div = document.createElement('div');
                div.id = 'dep-field';
                div.style.marginBottom = '10px';
                div.innerHTML = `<label style="color:#6f42c1; margin-top:10px;";>Regra de exibi√ß√£o (opcional):</label><input type="text" id="edit-depends" placeholder="Ex: moradia:0 (ID da pergunta pai:√≠ndice da op√ß√£o)"><small style="color:#666; display:block; margin-top:3px;">Deixe vazio para aparecer sempre. Use √≠ndice 0 para 1¬™ op√ß√£o, 1 para 2¬™...</small>`;
                const label = document.getElementById('edit-label');
                label.parentNode.insertBefore(div, label.nextSibling);
            }
        }

        function editSituation(i) {
            setupEdit('situation', i);
            if (i !== -1) {
                document.getElementById('edit-label').value = appData.situations[i].label;
                document.getElementById('sit-docs').value = appData.situations[i].docs.join('\n');
            }
        }

        function editQuestion(i) {
            setupEdit('question', i);
            if (i !== -1) {
                document.getElementById('edit-label').value = appData.questions[i].text;
                if (appData.questions[i].dependsOn) document.getElementById('edit-depends').value = appData.questions[i].dependsOn;
                appData.questions[i].options.forEach(o => addOptionRow(o.label, (o.docs || []).join('\n')));
            } else addOptionRow('', '');
        }

        function addOptionRow(l = '', d = '') {
            document.getElementById('options-container').innerHTML += `<div class="option-row" style="display:grid;grid-template-columns:1fr 2fr auto;gap:5px;margin-bottom:5px;"><input class="opt-label" value="${l}" placeholder="Digite a op√ß√£o."><textarea class="doc-input" placeholder="Um documento por linha (deixe em branco se para essa op√ß√£o n√£o houver documentos)">${d}</textarea><button type="button" onclick="this.parentElement.remove()">X</button></div>`;
        }

        function cancelEdit() {
            document.getElementById('edit-overlay').style.display = 'none';
        }
        async function saveEdit() {
            const type = document.getElementById('edit-type').value,
                id = parseInt(document.getElementById('edit-id').value),
                label = document.getElementById('edit-label').value;
            if (type === 'situation') {
                const docs = document.getElementById('sit-docs').value.split('\n').filter(x => x.trim());
                const obj = {
                    id: label.toLowerCase().replace(/\s/g, ''),
                    label,
                    docs
                };
                id === -1 ? appData.situations.push(obj) : appData.situations[id] = obj;
            } else {
                const ops = [];
                document.querySelectorAll('.option-row').forEach(r => ops.push({
                    label: r.querySelector('.opt-label').value,
                    docs: r.querySelector('.doc-input').value.split('\n').filter(x => x.trim())
                }));
                const dep = document.getElementById('edit-depends').value.trim();
                const oldId = (id !== -1 && appData.questions[id]) ? appData.questions[id].id : 'q' + Date.now();
                const obj = {
                    id: oldId,
                    text: label,
                    options: ops,
                    dependsOn: dep
                };
                id === -1 ? appData.questions.push(obj) : appData.questions[id] = obj;
            }
            if (await saveDataToCloud(true)) {
                renderAdminLists();
                cancelEdit();
            }
        }
        async function delItem(type, i) {
            if (!confirm('Excluir?')) return;
            type === 'situation' ? appData.situations.splice(i, 1) : appData.questions.splice(i, 1);
            if (await saveDataToCloud(true)) renderAdminLists();
        }
        async function moveItem(type, i, dir) {
            const list = type === 'situation' ? appData.situations : appData.questions;
            if (i + dir < 0 || i + dir >= list.length) return;
            [list[i], list[i + dir]] = [list[i + dir], list[i]];
            renderAdminLists();
            await saveDataToCloud(true);
        }
    </script>
</body>

</html>
